---
phase: 05-data-import
plan: 04
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - server/src/routers/imports.py
autonomous: true

must_haves:
  truths:
    - "Valid rows from the validation step are bulk-created as events in the case timeline"
    - "Import confirm endpoint creates events with correct field values from the mapping"
    - "Import summary shows final count of created events and any errors"
    - "Events created via import appear in the timeline ordered chronologically"
  artifacts:
    - path: "server/src/routers/imports.py"
      provides: "Confirm import endpoint that bulk-creates events"
  key_links:
    - from: "server/src/routers/imports.py"
      to: "server/src/models/event.py"
      via: "Event model creation in bulk"
    - from: "client/src/hooks/useImport.ts"
      to: "/api/cases/{caseId}/imports/confirm"
      via: "useConfirmImport mutation"
---

<objective>
Batch event creation endpoint with validation summary and error reporting.

Purpose: Complete the import flow by creating events from validated spreadsheet data, providing a clear summary of what was imported and any errors encountered.
Output: Confirm import endpoint that bulk-creates events from validated rows.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-data-import/05-RESEARCH.md
@.planning/phases/05-data-import/05-01-SUMMARY.md
@.planning/phases/05-data-import/05-02-SUMMARY.md
@server/src/routers/imports.py
@server/src/routers/events.py
@server/src/models/event.py
@server/src/schemas/import_.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement batch event creation endpoint</name>
  <files>
    server/src/routers/imports.py
  </files>
  <action>
  Add `POST /cases/{case_id}/imports/confirm` endpoint to imports router:

  1. Params: case_id (path), body (ImportConfirmRequest with session_id)
  2. Dependencies: db (get_db), current_user (get_current_user)
  3. Verify case exists.

  4. Retrieve session from _import_sessions by session_id. Return 404 if not found.
  5. Verify session belongs to current user. Return 403 if not.
  6. Verify session has validated_rows (validation step completed). Return 400 if missing ("Must validate mapping before confirming import").

  7. Get current max sort_order for the case's events (same pattern as create_event in events router):
     ```python
     result = await db.execute(
         select(func.coalesce(func.max(Event.sort_order), -1)).where(Event.case_id == case_id)
     )
     next_sort = (result.scalar() or 0) + 1
     ```

  8. Iterate over validated_rows. For each row where is_valid == True:
     - Create Event object with:
       - case_id=case_id
       - event_date from transformed data (REQUIRED)
       - event_time from transformed data (if mapped)
       - event_type from transformed data (default "note" if not mapped)
       - file_name, file_count, file_description, file_type from transformed data (if mapped)
       - metadata_={} (empty dict -- imports don't set metadata)
       - sort_order=next_sort (increment for each event)
       - created_by_id=current_user.id
     - db.add(event)
     - Increment next_sort
     - Wrap individual event creation in try/except to catch validation errors per-row

  9. Commit all events in a single transaction (await db.commit()).
     - If commit fails, return error with details.
     - If individual rows fail, collect error messages.

  10. Clean up: delete session from _import_sessions after successful import.

  11. Return ImportConfirmResponse with created_count, error_count, and any error messages.

  12. Add session cleanup: Add a simple cleanup mechanism -- when a new upload is performed, remove sessions older than 1 hour (compare stored timestamps). Add `created_at` (datetime.now()) to session storage in the upload endpoint.
  </action>
  <verify>
  Run: `cd /Users/shiro/projec1/server && python -c "from src.routers.imports import router; routes = [r.path for r in router.routes]; print('Routes:', routes); assert any('confirm' in r for r in routes); print('Confirm endpoint OK')"`
  </verify>
  <done>Confirm endpoint bulk-creates events from validated rows, handles errors per-row, returns creation summary, and cleans up session storage.</done>
</task>

<task type="auto">
  <name>Task 2: Add upload method to api helper and wire confirm flow</name>
  <files>
    client/src/lib/api.ts
  </files>
  <action>
  Add an `upload` method to the api helper in `client/src/lib/api.ts`:

  ```typescript
  upload<T>(url: string, file: File, fieldName: string = "file"): Promise<T> {
    const formData = new FormData();
    formData.append(fieldName, file);
    // Don't set Content-Type header -- browser sets it with boundary for FormData
    return request<T>(url, {
      method: "POST",
      body: formData,
    });
  }
  ```

  This avoids the JSON Content-Type header that the post method adds. The existing request function handles auth token.

  Update the useUploadFile hook in `client/src/hooks/useImport.ts` to use `api.upload` instead of raw fetch if it was implemented that way. Ensure the upload hook uses this new method.
  </action>
  <verify>
  Run: `cd /Users/shiro/projec1/client && npx tsc --noEmit --pretty 2>&1 | head -20`
  </verify>
  <done>API helper supports multipart file uploads. Import confirm flow is fully wired from frontend to backend.</done>
</task>

</tasks>

<verification>
1. Confirm endpoint exists at /cases/{case_id}/imports/confirm
2. Bulk event creation works for valid rows
3. Error rows are skipped with error messages in response
4. Created events appear in timeline (chronologically ordered)
5. Session cleanup removes stale import sessions
6. TypeScript compiles without errors
</verification>

<success_criteria>
- Valid rows create events with correct field values
- Invalid rows are skipped with error messages
- Import summary shows created count and error count (IMPT-03)
- Events appear in timeline after import
- Session is cleaned up after import completes
- Full flow works: upload -> map -> validate -> confirm -> events in timeline
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-import/05-04-SUMMARY.md`
</output>
