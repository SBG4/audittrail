---
phase: 05-data-import
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - client/src/types/import.ts
  - client/src/hooks/useImport.ts
  - client/src/components/import/FileUpload.tsx
  - client/src/components/import/ColumnMapper.tsx
  - client/src/components/import/ImportSummary.tsx
  - client/src/pages/ImportPage.tsx
  - client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can upload an Excel or CSV file and see parsed column headers"
    - "User can map spreadsheet columns to event fields using dropdown selectors"
    - "User sees a preview of sample data rows alongside the mapping"
    - "Import page is accessible from the case detail page"
  artifacts:
    - path: "client/src/types/import.ts"
      provides: "TypeScript types for import flow"
    - path: "client/src/hooks/useImport.ts"
      provides: "TanStack Query hooks for upload and validation"
    - path: "client/src/components/import/ColumnMapper.tsx"
      provides: "Column mapping wizard component"
    - path: "client/src/pages/ImportPage.tsx"
      provides: "Import wizard page with multi-step flow"
  key_links:
    - from: "client/src/hooks/useImport.ts"
      to: "/api/cases/{caseId}/imports/upload"
      via: "fetch POST with FormData"
    - from: "client/src/pages/ImportPage.tsx"
      to: "client/src/components/import/ColumnMapper.tsx"
      via: "Step 2 of wizard flow"
    - from: "client/src/App.tsx"
      to: "client/src/pages/ImportPage.tsx"
      via: "Route /cases/:id/import"
---

<objective>
Column mapping wizard UI with file upload, field matching, and data preview.

Purpose: Provide auditors with an intuitive multi-step interface to upload a spreadsheet, map its columns to event fields, and preview the data before importing.
Output: Import page with FileUpload, ColumnMapper, and ImportSummary components.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-data-import/05-RESEARCH.md
@.planning/phases/05-data-import/05-01-SUMMARY.md
@client/src/lib/api.ts
@client/src/hooks/useEvents.ts
@client/src/types/event.ts
@client/src/App.tsx
@client/src/pages/CaseDetailPage.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript types and TanStack Query hooks for import</name>
  <files>
    client/src/types/import.ts
    client/src/hooks/useImport.ts
  </files>
  <action>
  1. Create `client/src/types/import.ts`:

  ```typescript
  export interface ImportUploadResponse {
    session_id: string;
    filename: string;
    headers: string[];
    row_count: number;
    preview_rows: (string | number | null)[][];
  }

  export interface ColumnMappingRequest {
    session_id: string;
    mappings: Record<string, string>;  // spreadsheet col -> event field
  }

  export interface ImportValidationRow {
    row_number: number;
    valid: boolean;
    errors: string[];
    data: Record<string, unknown>;
  }

  export interface ImportValidationResponse {
    session_id: string;
    total_rows: number;
    valid_count: number;
    error_count: number;
    rows: ImportValidationRow[];
  }

  export interface ImportConfirmRequest {
    session_id: string;
  }

  export interface ImportConfirmResponse {
    created_count: number;
    error_count: number;
    errors: string[];
  }
  ```

  2. Create `client/src/hooks/useImport.ts`:

  - `useUploadFile(caseId: string)`: useMutation that:
    - Creates FormData with the file
    - POSTs to `/api/cases/${caseId}/imports/upload` using fetch directly (not api.post, since FormData needs multipart encoding)
    - Include Authorization header from localStorage token
    - Returns ImportUploadResponse
    - NOTE: The existing api helper sets Content-Type to application/json. For file upload, use raw fetch with FormData (browser sets Content-Type with boundary automatically).

  - `useValidateMapping(caseId: string)`: useMutation that:
    - POSTs ColumnMappingRequest to `/api/cases/${caseId}/imports/validate`
    - Uses api.post (JSON body)
    - Returns ImportValidationResponse

  - `useConfirmImport(caseId: string)`: useMutation that:
    - POSTs ImportConfirmRequest to `/api/cases/${caseId}/imports/confirm`
    - Uses api.post (JSON body)
    - On success, invalidates ["events", caseId] query to refresh timeline
    - Returns ImportConfirmResponse
  </action>
  <verify>
  Run: `cd /Users/shiro/projec1/client && npx tsc --noEmit --pretty 2>&1 | head -20`
  Verify no type errors in import.ts or useImport.ts.
  </verify>
  <done>TypeScript types and TanStack Query hooks exist for all three import steps (upload, validate, confirm).</done>
</task>

<task type="auto">
  <name>Task 2: Create import wizard components and page</name>
  <files>
    client/src/components/import/FileUpload.tsx
    client/src/components/import/ColumnMapper.tsx
    client/src/components/import/ImportSummary.tsx
    client/src/pages/ImportPage.tsx
    client/src/App.tsx
  </files>
  <action>
  1. Create `client/src/components/import/FileUpload.tsx`:
     - Props: `onUploadComplete: (response: ImportUploadResponse) => void`, `caseId: string`
     - File input (accept .csv,.xlsx,.xls) with drag-and-drop area
     - Use a visible dropzone div with border-dashed styling
     - On file select or drop: call useUploadFile mutation
     - Show loading state during upload
     - Show error messages for rejected files
     - On success: call onUploadComplete with response

  2. Create `client/src/components/import/ColumnMapper.tsx`:
     - Props: `uploadResponse: ImportUploadResponse`, `onMappingComplete: (response: ImportValidationResponse) => void`, `caseId: string`
     - Display spreadsheet headers in a list/grid
     - For each header, show a dropdown select to choose the event field to map to:
       - Options: "(skip)", "Event Date", "Event Time", "Event Type", "File Name", "File Count", "File Description", "File Type"
       - Value mapping: { "event_date": "Event Date", "event_time": "Event Time", etc. }
     - Show preview table of first 5 rows from uploadResponse.preview_rows
     - Highlight mapped columns in the preview
     - "Validate" button: calls useValidateMapping with the mappings
     - Disable Validate if event_date is not mapped (show helper text: "Event Date mapping is required")
     - On validation success: call onMappingComplete

  3. Create `client/src/components/import/ImportSummary.tsx`:
     - Props: `validationResponse: ImportValidationResponse`, `onConfirm: () => void`, `onBack: () => void`, `isConfirming: boolean`
     - Show summary stats: total rows, valid count (green), error count (red)
     - Show scrollable table of validation results:
       - Row number, status (valid/error icon), error messages
       - Green check for valid rows, red X for error rows
     - "Import {N} Events" button (only valid rows will be imported)
     - "Back" button to return to mapping step
     - Disable confirm button if valid_count is 0

  4. Create `client/src/pages/ImportPage.tsx`:
     - Multi-step wizard: Step 1 (Upload) -> Step 2 (Map Columns) -> Step 3 (Review & Confirm)
     - Use useState for current step and intermediate data (uploadResponse, validationResponse)
     - Get caseId from useParams
     - Step indicator showing current progress (1/2/3)
     - Back to case link at the top
     - On confirm success: show success message, navigate back to case detail timeline tab

  5. Update `client/src/App.tsx`:
     - Add route: `<Route path="/cases/:id/import" element={<ImportPage />} />`
     - Import ImportPage

  6. Add "Import Data" button to CaseDetailPage.tsx timeline tab:
     - In the TimelineView header area of CaseDetailPage, add a Link/Button to `/cases/${id}/import`
     - Use Upload icon from lucide-react
     - Position next to the existing "Add Event" button area
     - Actually, add this to TimelineView.tsx: next to the "Add Event" button, add a Link to the import page.
     - Update: `client/src/components/timeline/TimelineView.tsx` - add `import { Link } from "react-router"` and add an "Import" button linking to `/cases/${caseId}/import` in the header bar next to "Add Event".
  </action>
  <verify>
  Run: `cd /Users/shiro/projec1/client && npx tsc --noEmit --pretty 2>&1 | head -30`
  Verify no type errors. Verify ImportPage route exists in App.tsx.
  </verify>
  <done>Import wizard page with three-step flow (upload, map, review) is accessible from case detail timeline, with file upload, column mapping dropdowns, preview table, and validation summary.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. ImportPage route accessible at /cases/:id/import
3. FileUpload component handles .csv and .xlsx files
4. ColumnMapper shows dropdowns for all spreadsheet headers
5. ImportSummary shows validation stats and per-row details
6. "Import Data" button visible on timeline view
</verification>

<success_criteria>
- Multi-step wizard guides user through upload -> map -> review flow
- Column mapping uses dropdown selects (not drag-and-drop to keep simple)
- Preview table shows sample data alongside mapping
- Event Date mapping is required before validation can proceed
- Import button visible on case timeline for easy access
</success_criteria>

<output>
After completion, create `.planning/phases/05-data-import/05-03-SUMMARY.md`
</output>
