---
phase: 04-file-batch-grouping
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - client/src/types/file-batch.ts
  - client/src/hooks/useFileBatches.ts
  - client/src/components/batches/BatchList.tsx
  - client/src/components/batches/BatchForm.tsx
autonomous: true

must_haves:
  truths:
    - "User can see file batches attached to a timeline event"
    - "User can create a new file batch on an event with label, count, description, and file types"
    - "User can edit an existing file batch inline"
    - "User can delete a file batch from an event"
    - "Multiple batches can be attached to a single event"
  artifacts:
    - path: "client/src/types/file-batch.ts"
      provides: "TypeScript interfaces for file batch data"
      exports: ["FileBatch", "CreateFileBatchRequest", "UpdateFileBatchRequest"]
    - path: "client/src/hooks/useFileBatches.ts"
      provides: "TanStack Query hooks for batch CRUD"
      exports: ["useFileBatches", "useCreateFileBatch", "useUpdateFileBatch", "useDeleteFileBatch"]
    - path: "client/src/components/batches/BatchList.tsx"
      provides: "Batch list display with edit/delete actions"
      contains: "BatchList"
    - path: "client/src/components/batches/BatchForm.tsx"
      provides: "Create/edit form for file batch"
      contains: "BatchForm"
  key_links:
    - from: "client/src/hooks/useFileBatches.ts"
      to: "/api/cases/{caseId}/events/{eventId}/batches"
      via: "api.get, api.post, api.patch, api.delete"
      pattern: "api\\.(get|post|patch|delete).*batches"
    - from: "client/src/components/batches/BatchList.tsx"
      to: "client/src/hooks/useFileBatches.ts"
      via: "hook imports"
      pattern: "useFileBatches|useDeleteFileBatch"
    - from: "client/src/components/batches/BatchForm.tsx"
      to: "client/src/hooks/useFileBatches.ts"
      via: "mutation hooks"
      pattern: "useCreateFileBatch|useUpdateFileBatch"
---

<objective>
File batch UI components within timeline events for creating, editing, and managing multiple batch groups per event.

Purpose: Provides the user-facing interface for the file batch grouping feature. Auditors can view, create, edit, and delete file batch metadata directly within the timeline event display, maintaining the inline editing workflow established in Phase 2.

Output: TypeScript types, TanStack Query hooks, BatchList and BatchForm components.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-file-batch-grouping/04-RESEARCH.md
@.planning/phases/04-file-batch-grouping/04-01-SUMMARY.md
@client/src/types/case.ts
@client/src/hooks/useCases.ts
@client/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and TanStack Query hooks for file batches</name>
  <files>
    client/src/types/file-batch.ts
    client/src/hooks/useFileBatches.ts
  </files>
  <action>
    Create TypeScript types in `client/src/types/file-batch.ts`:
    ```typescript
    export interface FileBatch {
      id: string;
      event_id: string;
      label: string;
      file_count: number;
      description: string | null;
      file_types: string | null;
      sort_order: number;
      created_at: string;
      updated_at: string;
    }

    export interface CreateFileBatchRequest {
      label: string;
      file_count: number;
      description?: string;
      file_types?: string;
      sort_order?: number;
    }

    export interface UpdateFileBatchRequest {
      label?: string;
      file_count?: number;
      description?: string;
      file_types?: string;
      sort_order?: number;
    }
    ```

    Create TanStack Query hooks in `client/src/hooks/useFileBatches.ts`:
    Follow the exact same patterns as `useCases.ts`:

    - `useFileBatches(caseId: string, eventId: string)`: useQuery with queryKey ["file-batches", caseId, eventId], calls GET `/api/cases/${caseId}/events/${eventId}/batches`, enabled when both IDs truthy
    - `useCreateFileBatch(caseId: string, eventId: string)`: useMutation calling POST, onSuccess invalidates ["file-batches", caseId, eventId] AND ["events", caseId] (to refresh embedded batches in event responses)
    - `useUpdateFileBatch(caseId: string, eventId: string)`: useMutation calling PATCH `.../{batchId}`, mutationFn takes `{ id, ...body }` pattern (same as useUpdateCase), onSuccess invalidates same keys
    - `useDeleteFileBatch(caseId: string, eventId: string)`: useMutation calling DELETE `.../{batchId}`, onSuccess invalidates same keys
  </action>
  <verify>
    - TypeScript compiles: `cd client && npx tsc --noEmit --pretty 2>&1 | head -20`
    - Types file exports all 3 interfaces
    - Hooks file exports all 4 hooks
  </verify>
  <done>TypeScript interfaces for FileBatch, create/update requests, and 4 TanStack Query hooks (list, create, update, delete) with proper cache invalidation of both batch and event query keys.</done>
</task>

<task type="auto">
  <name>Task 2: BatchList and BatchForm components</name>
  <files>
    client/src/components/batches/BatchList.tsx
    client/src/components/batches/BatchForm.tsx
  </files>
  <action>
    Create `client/src/components/batches/BatchList.tsx`:
    - Props: `caseId: string`, `eventId: string`, `batches: FileBatch[]` (batches come from event response, not separate fetch)
    - Display each batch as a compact row showing:
      - Package icon (lucide-react) + label (bold)
      - Badge with file count (e.g., "42 files")
      - File types in muted text
      - Description (if present) as secondary text
    - Each batch row has inline edit (pencil icon) and delete (trash icon) buttons on hover
    - Edit opens a BatchForm in edit mode (inline, not modal)
    - Delete calls useDeleteFileBatch with confirmation
    - "Add batch" button at bottom opens BatchForm in create mode
    - Empty state: muted text "No file batches. Add one to track file evidence."

    Create `client/src/components/batches/BatchForm.tsx`:
    - Props: `caseId: string`, `eventId: string`, `batch?: FileBatch` (undefined = create, defined = edit), `onClose: () => void`
    - Form fields:
      - Label: Input (required, placeholder "e.g., USB File Copy")
      - File Count: Input type="number" (required, min=0, placeholder "Number of files")
      - File Types: Input (optional, placeholder ".pdf, .docx, .xlsx")
      - Description: Textarea (optional, placeholder "Brief description of the file batch")
    - Save button calls useCreateFileBatch or useUpdateFileBatch depending on mode
    - Cancel button calls onClose
    - On successful mutation, call onClose
    - Show error message from mutation error
    - Form is compact (single column, minimal spacing) to fit inline within event display

    Both components use shadcn/ui components (Button, Input, Textarea, Badge) and follow the inline editing UX patterns from Phase 2 (CaseMetadata, CaseDetailPage).
  </action>
  <verify>
    - TypeScript compiles: `cd client && npx tsc --noEmit --pretty 2>&1 | head -20`
    - BatchList component renders batch data and has add/edit/delete actions
    - BatchForm has all 4 fields and handles create/edit modes
  </verify>
  <done>BatchList component displays batches inline with edit/delete actions. BatchForm provides create/edit with label, file_count, file_types, description fields. Both use established shadcn/ui patterns and TanStack Query hooks for data mutations with cache invalidation.</done>
</task>

</tasks>

<verification>
- TypeScript compiles with no errors
- BatchList renders file batches with icons, counts, and file type info
- BatchForm creates new batches and edits existing ones
- Mutations invalidate correct query keys (file-batches and events)
- Components integrate into timeline event display (Phase 3's event components)
</verification>

<success_criteria>
- User can see a list of file batches on each timeline event
- User can add a new file batch using an inline form with label, count, description, file types
- User can edit any existing file batch
- User can delete a file batch
- Multiple batches display correctly on a single event
- Form handles validation (required label, non-negative count)
- Mutations update the UI via cache invalidation
</success_criteria>

<output>
After completion, create `.planning/phases/04-file-batch-grouping/04-02-SUMMARY.md`
</output>
