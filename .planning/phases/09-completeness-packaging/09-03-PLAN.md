---
phase: 09-completeness-packaging
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/package-airgap.sh
  - scripts/load-airgap.sh
  - scripts/verify-deployment.sh
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Application is packaged as Docker image tarballs with checksums for USB transfer"
    - "A load script restores images and starts the application on an airgapped machine"
    - "SHA256 checksums verify file integrity after USB transfer"
  artifacts:
    - path: "scripts/package-airgap.sh"
      provides: "Builds and exports Docker images to compressed tarball with checksums"
    - path: "scripts/load-airgap.sh"
      provides: "Loads images from tarball and starts application"
    - path: "scripts/verify-deployment.sh"
      provides: "Verifies deployment is running correctly"
    - path: ".env.example"
      provides: "Template environment file for deployment"
  key_links:
    - from: "scripts/package-airgap.sh"
      to: "docker-compose.yml"
      via: "docker compose build and save"
      pattern: "docker compose"
    - from: "scripts/load-airgap.sh"
      to: "docker-compose.yml"
      via: "docker compose up after load"
      pattern: "docker compose up"
---

<objective>
Create airgap deployment packaging scripts that bundle the entire application (Docker images, compose file, env template, and load script) into a single transferable package for USB deployment to airgapped networks.

Purpose: Implements INFR-01/INFR-02 airgap requirement -- the application must deploy without internet
Output: package-airgap.sh (build machine), load-airgap.sh (target machine), verify-deployment.sh, .env.example
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@docker-compose.yml
@scripts/verify-integration.sh
@scripts/verify-airgap.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create packaging and load scripts</name>
  <files>
    scripts/package-airgap.sh
    scripts/load-airgap.sh
    .env.example
  </files>
  <action>
**scripts/package-airgap.sh:**
```
#!/bin/bash
set -euo pipefail
```

Script that runs on the BUILD machine (with internet) to create the airgap package:

1. Print banner: "AuditTrail Airgap Packaging"
2. Set VERSION variable: `VERSION=${1:-$(date +%Y%m%d-%H%M%S)}`
3. Set OUTDIR: `audittrail-airgap-${VERSION}`
4. Create output directory: `mkdir -p "$OUTDIR"`

5. **Build images:**
   - `echo "Building Docker images..."`
   - `docker compose build --no-cache`

6. **Export images:**
   - `echo "Exporting Docker images (this may take a few minutes)..."`
   - Get image list: `IMAGES=$(docker compose config --images)`
   - Save all images compressed: `docker save $IMAGES | gzip > "$OUTDIR/images.tar.gz"`
   - Print size: `echo "Image archive: $(du -h "$OUTDIR/images.tar.gz" | cut -f1)"`

7. **Copy deployment files:**
   - Copy docker-compose.yml to OUTDIR
   - Copy .env.example to OUTDIR/.env
   - Copy scripts/load-airgap.sh to OUTDIR/load.sh
   - Copy scripts/verify-deployment.sh to OUTDIR/verify.sh
   - Make scripts executable: `chmod +x "$OUTDIR/load.sh" "$OUTDIR/verify.sh"`

8. **Generate checksums:**
   - Use portable checksum command: detect `sha256sum` (Linux) or `shasum -a 256` (macOS)
   - Store in variable: `SHA_CMD="sha256sum"` or `SHA_CMD="shasum -a 256"`
   - `cd "$OUTDIR" && $SHA_CMD images.tar.gz docker-compose.yml .env > SHA256SUMS`

9. **Create final tarball:**
   - `cd .. && tar czf "${OUTDIR}.tar.gz" "$OUTDIR/"`
   - Print final size and path

10. Print summary:
    ```
    Package created: audittrail-airgap-VERSION.tar.gz
    Transfer this file to the airgapped network via USB.
    On the target machine:
      tar xzf audittrail-airgap-VERSION.tar.gz
      cd audittrail-airgap-VERSION
      ./load.sh
    ```

**scripts/load-airgap.sh:**
```
#!/bin/bash
set -euo pipefail
```

Script that runs on the TARGET airgapped machine:

1. Print banner: "AuditTrail Airgap Deployment"

2. **Check prerequisites:**
   - Check `docker` command exists, exit with error if not
   - Check `docker compose` command exists, exit with error if not
   - Check images.tar.gz exists in current directory, exit with error if not

3. **Verify checksums (optional):**
   - If SHA256SUMS exists, verify: `$SHA_CMD --check SHA256SUMS`
   - Print pass/fail for each file
   - On failure, warn but ask if user wants to continue

4. **Load Docker images:**
   - `echo "Loading Docker images (this may take a few minutes)..."`
   - `docker load < images.tar.gz` (with gunzip piped if needed, but docker load auto-detects gzip)
   - Actually: `gunzip -c images.tar.gz | docker load` to be safe

5. **Start application:**
   - `echo "Starting application..."`
   - `docker compose up -d`

6. **Wait for health:**
   - Loop up to 30 seconds checking `curl -sf http://localhost/api/health`
   - Print status dots while waiting
   - On success: print "Application is running at http://localhost"
   - On failure: print "Application may still be starting. Check: docker compose logs"

7. Print usage info:
    ```
    Default credentials: admin / changeme
    Change password after first login.
    To stop: docker compose down
    To restart: docker compose up -d
    To check logs: docker compose logs -f
    ```

**.env.example:**
Create if it doesn't already exist. Contents:
```
# AuditTrail Environment Configuration
# Copy to .env and customize as needed

# Database credentials
DB_USER=audittrail
DB_PASSWORD=audittrail

# JWT secret key - CHANGE THIS IN PRODUCTION
SECRET_KEY=change-me-in-production

# Application port (default: 80)
APP_PORT=80
```
  </action>
  <verify>Scripts have correct shebang, are syntactically valid (bash -n scripts/package-airgap.sh), and contain all required steps.</verify>
  <done>package-airgap.sh builds and exports Docker images with checksums. load-airgap.sh loads images, verifies checksums, and starts the application. .env.example provides configuration template.</done>
</task>

<task type="auto">
  <name>Task 2: Create deployment verification script</name>
  <files>scripts/verify-deployment.sh</files>
  <action>
**scripts/verify-deployment.sh:**
```
#!/bin/bash
set -euo pipefail
```

A compact verification script for the target machine (simpler than verify-integration.sh):

1. Print banner: "AuditTrail Deployment Verification"
2. Initialize PASS/FAIL counters

3. **Check Docker services:**
   - Verify db, api, nginx containers are running via `docker compose ps`

4. **Check API health:**
   - `curl -sf http://localhost/api/health` should return `{"status":"ok"}`

5. **Check login:**
   - POST to /api/auth/login with admin/changeme credentials
   - Verify 200 response with access_token

6. **Check frontend:**
   - GET / should return 200

7. **Check airgap (no external calls):**
   - `docker compose exec api python -c "import socket; socket.setdefaulttimeout(2); socket.create_connection(('8.8.8.8', 53))"` should FAIL (proving no external network)
   - This test is optional and may not work in all environments -- wrap in try/catch and report as info, not fail

8. Print summary: PASS/FAIL counts, overall status

Make the script work standalone (can be run from the OUTDIR without being in the project root).
  </action>
  <verify>bash -n scripts/verify-deployment.sh passes (no syntax errors). Script has correct structure with pass/fail counting.</verify>
  <done>verify-deployment.sh checks all services, API health, authentication, frontend, and optionally network isolation. Reports pass/fail for each check.</done>
</task>

</tasks>

<verification>
1. `bash -n scripts/package-airgap.sh` -- no syntax errors
2. `bash -n scripts/load-airgap.sh` -- no syntax errors
3. `bash -n scripts/verify-deployment.sh` -- no syntax errors
4. Scripts use `set -euo pipefail` for safety
5. Checksum command is cross-platform (Linux/macOS)
6. .env.example has all required variables from docker-compose.yml
</verification>

<success_criteria>
- package-airgap.sh creates a self-contained tarball with images, compose file, env, and load script
- load-airgap.sh loads images, verifies checksums, starts application, and waits for health
- verify-deployment.sh confirms all services are running correctly
- All scripts are syntactically valid bash
- Cross-platform checksum detection (sha256sum / shasum)
</success_criteria>

<output>
After completion, create `.planning/phases/09-completeness-packaging/09-03-SUMMARY.md`
</output>
