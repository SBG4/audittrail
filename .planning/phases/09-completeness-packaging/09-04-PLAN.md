---
phase: 09-completeness-packaging
plan: 04
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03"]
files_modified:
  - DEPLOYMENT.md
autonomous: true

must_haves:
  truths:
    - "End-to-end deployment process is documented with step-by-step instructions"
    - "Document covers build machine steps, USB transfer, and target machine setup"
    - "Verification checklist confirms all features work after deployment"
  artifacts:
    - path: "DEPLOYMENT.md"
      provides: "Complete airgap deployment guide"
  key_links:
    - from: "DEPLOYMENT.md"
      to: "scripts/package-airgap.sh"
      via: "references packaging script"
      pattern: "package-airgap"
    - from: "DEPLOYMENT.md"
      to: "scripts/load-airgap.sh"
      via: "references load script"
      pattern: "load-airgap"
---

<objective>
Create end-to-end deployment documentation and a verification checklist that covers the complete USB deployment lifecycle: build, package, transfer, load, verify.

Purpose: Operators on the airgapped network need clear instructions to deploy without developer assistance
Output: DEPLOYMENT.md with full deployment guide
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-completeness-packaging/09-03-SUMMARY.md
@docker-compose.yml
@scripts/package-airgap.sh
@scripts/load-airgap.sh
@scripts/verify-deployment.sh
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive deployment guide</name>
  <files>DEPLOYMENT.md</files>
  <action>
Create `DEPLOYMENT.md` at the project root with the following sections:

**Title:** AuditTrail - Airgap Deployment Guide

**Section 1: Overview**
- What this guide covers: packaging AuditTrail on a build machine with internet, transferring to an airgapped network via USB, and deploying on the target machine
- Prerequisites for build machine: Docker, Docker Compose, git, bash, internet access
- Prerequisites for target machine: Docker, Docker Compose, bash (no internet required)

**Section 2: Build Machine - Packaging**
- Step 1: Clone repository (or ensure source is available)
- Step 2: Run packaging script: `bash scripts/package-airgap.sh [version]`
- Step 3: Verify package created: `ls -la audittrail-airgap-*.tar.gz`
- Step 4: Copy tarball to USB drive
- Note estimated package size (~500MB-1GB compressed)

**Section 3: Target Machine - Deployment**
- Step 1: Insert USB drive, copy tarball to local disk
- Step 2: Extract: `tar xzf audittrail-airgap-*.tar.gz`
- Step 3: Enter directory: `cd audittrail-airgap-*`
- Step 4: (Optional) Edit .env to change default passwords
- Step 5: Run load script: `./load.sh`
- Step 6: Wait for "Application is running" message
- Step 7: Open browser to http://localhost (or the configured port)

**Section 4: Verification**
- Run `./verify.sh` from the deployment directory
- Expected output: all checks pass
- Manual verification steps:
  1. Open http://localhost in browser
  2. Log in with admin/changeme
  3. Create a new case
  4. Add events to the timeline
  5. Verify all data persists after docker compose down/up

**Section 5: Configuration**
- Environment variables table (from .env.example):
  | Variable | Default | Description |
  | DB_USER | audittrail | PostgreSQL username |
  | DB_PASSWORD | audittrail | PostgreSQL password |
  | SECRET_KEY | change-me-in-production | JWT signing key |
  | APP_PORT | 80 | HTTP port |
- How to change configuration: edit .env, restart with `docker compose down && docker compose up -d`
- IMPORTANT: Change SECRET_KEY and DB_PASSWORD before first use in production

**Section 6: Operations**
- Starting: `docker compose up -d`
- Stopping: `docker compose down`
- Viewing logs: `docker compose logs -f [service]`
- Data backup: `docker compose exec db pg_dump -U audittrail audittrail > backup.sql`
- Data restore: `docker compose exec -i db psql -U audittrail audittrail < backup.sql`
- Updating: Re-run packaging on build machine with new version, transfer, and re-run load.sh

**Section 7: Troubleshooting**
- "Port 80 already in use" -> Change APP_PORT in .env
- "Cannot connect to Docker daemon" -> Ensure Docker is running
- "Image not found" -> Re-run load.sh to reload images
- "Database connection refused" -> Wait 10-15 seconds for PostgreSQL to initialize, check `docker compose logs db`
- Checksum mismatch -> Re-copy from USB, check for corruption

Keep the document practical and operator-focused. No developer jargon. Clear numbered steps.
  </action>
  <verify>DEPLOYMENT.md exists, covers all sections, has clear step-by-step instructions. No broken references to scripts.</verify>
  <done>DEPLOYMENT.md provides complete end-to-end airgap deployment guide covering packaging, transfer, deployment, verification, configuration, operations, and troubleshooting.</done>
</task>

</tasks>

<verification>
1. DEPLOYMENT.md covers build machine packaging steps
2. DEPLOYMENT.md covers USB transfer steps
3. DEPLOYMENT.md covers target machine deployment steps
4. DEPLOYMENT.md includes verification checklist
5. DEPLOYMENT.md references correct script names
6. DEPLOYMENT.md includes configuration/operations/troubleshooting
</verification>

<success_criteria>
- Operator on airgapped network can follow the guide without developer assistance
- All scripts referenced in the guide exist in the repository
- Guide covers the complete lifecycle: package -> transfer -> deploy -> verify
- Troubleshooting section covers common failure modes
</success_criteria>

<output>
After completion, create `.planning/phases/09-completeness-packaging/09-04-SUMMARY.md`
</output>
