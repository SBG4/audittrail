---
phase: 02-audit-schemas-cases
plan: 05
type: execute
wave: 4
depends_on: ["02-03", "02-04"]
files_modified:
  - client/src/pages/CaseDetailPage.tsx
  - client/src/components/cases/CaseMetadata.tsx
  - client/src/components/cases/LifecycleControl.tsx
  - client/src/components/cases/AssigneeSelect.tsx
  - client/src/hooks/useUsers.ts
  - client/src/components/ui/tabs.tsx
  - client/src/components/ui/dialog.tsx
  - client/src/App.tsx
  - server/src/routers/users.py
  - server/src/main.py
autonomous: false

must_haves:
  truths:
    - "User can view full case details including metadata, status, assignee, and dates"
    - "User can edit case metadata inline without navigating to a separate page"
    - "User can change case lifecycle state via a control (open->active->closed, closed->open)"
    - "User can assign a case to any active team member"
    - "User can delete a case from the detail view with confirmation"
    - "Case detail page has tabs for organizing content (Overview, Timeline placeholder)"
  artifacts:
    - path: "client/src/pages/CaseDetailPage.tsx"
      provides: "Full case detail view with tabs"
      contains: "CaseDetailPage"
    - path: "client/src/components/cases/CaseMetadata.tsx"
      provides: "Inline-editable metadata display using SchemaForm"
      contains: "CaseMetadata"
    - path: "client/src/components/cases/LifecycleControl.tsx"
      provides: "Status badge with transition buttons"
      contains: "LifecycleControl"
    - path: "client/src/components/cases/AssigneeSelect.tsx"
      provides: "User assignment dropdown"
      contains: "AssigneeSelect"
    - path: "server/src/routers/users.py"
      provides: "GET /users endpoint for assignment dropdown"
      exports: ["router"]
  key_links:
    - from: "client/src/pages/CaseDetailPage.tsx"
      to: "client/src/hooks/useCases.ts"
      via: "useCase and useUpdateCase hooks"
      pattern: "useCase|useUpdateCase"
    - from: "client/src/components/cases/CaseMetadata.tsx"
      to: "client/src/components/cases/SchemaForm.tsx"
      via: "SchemaForm for editing"
      pattern: "<SchemaForm"
    - from: "client/src/components/cases/AssigneeSelect.tsx"
      to: "server/src/routers/users.py"
      via: "GET /users API"
      pattern: "api.*users"
---

<objective>
Create the case detail view with tabbed layout, inline metadata editing, lifecycle state controls, user assignment, and case deletion with confirmation.

Purpose: Provides the complete case management experience where auditors view all case information, edit metadata in-place, manage lifecycle states, and assign cases to team members.
Output: CaseDetailPage with inline editing, lifecycle controls, assignment, and delete functionality.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-audit-schemas-cases/02-RESEARCH.md
@.planning/phases/02-audit-schemas-cases/02-03-SUMMARY.md
@.planning/phases/02-audit-schemas-cases/02-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Users API endpoint, AssigneeSelect, and LifecycleControl</name>
  <files>
    server/src/routers/users.py
    server/src/main.py
    client/src/hooks/useUsers.ts
    client/src/components/cases/AssigneeSelect.tsx
    client/src/components/cases/LifecycleControl.tsx
    client/src/components/ui/dialog.tsx
  </files>
  <action>
    **Backend: Users list endpoint**

    Create `server/src/routers/users.py` with APIRouter(prefix="/users", tags=["users"]):
    - GET "/" -> list all active users. Protected with get_current_user. Returns list of UserRead. Query: `select(User).where(User.is_active == True).order_by(User.full_name)`.

    Register in `server/src/main.py`: import and include `users_router`.

    **Frontend hooks and components:**

    Add shadcn dialog component:
    ```bash
    cd client && npx shadcn@latest add dialog
    ```

    Create `client/src/hooks/useUsers.ts`:
    - `useUsers()` hook using useQuery: queryKey ["users"], queryFn fetches GET /api/users, returns UserInfo[]. staleTime: 10 minutes (user list changes infrequently).

    Create `client/src/components/cases/AssigneeSelect.tsx`:
    - Props: currentAssigneeId (string | null), onAssign (callback receiving userId: string | null), disabled? (boolean)
    - Uses useUsers() to populate a Select dropdown
    - Options: "Unassigned" (value=null), then each user by full_name
    - Shows current assignee as the selected value
    - On change, calls onAssign with the selected user ID (or null for unassigned)
    - Shows loading state while users are being fetched

    Create `client/src/components/cases/LifecycleControl.tsx`:
    - Props: currentStatus (string), onStatusChange (callback receiving new status string), disabled? (boolean)
    - Displays current status as a color-coded Badge (same colors as CaseList: open=blue outline, active=green, closed=gray)
    - Shows available transition buttons based on current status:
      - "open" -> shows "Start" (-> active) and "Close" (-> closed) buttons
      - "active" -> shows "Close" (-> closed) button
      - "closed" -> shows "Reopen" (-> open) button
    - Transition buttons are styled: "Start" = primary, "Close" = destructive variant, "Reopen" = outline
    - Clicking a transition button calls onStatusChange with the target status
    - Layout: Badge on the left, transition buttons on the right, in a flex row
  </action>
  <verify>
    - `cd server && python -c "from src.routers.users import router; print('Users router OK')"` succeeds
    - `cd server && python -c "from src.main import app; paths = [r.path for r in app.routes]; print([p for p in paths if 'users' in p])"` shows /users route
    - `cd client && npx tsc --noEmit` passes
  </verify>
  <done>Users API endpoint exists for populating assignment dropdown. AssigneeSelect shows user list with current selection. LifecycleControl displays status badge with valid transition buttons.</done>
</task>

<task type="auto">
  <name>Task 2: CaseMetadata inline editing and CaseDetailPage</name>
  <files>
    client/src/components/cases/CaseMetadata.tsx
    client/src/pages/CaseDetailPage.tsx
    client/src/components/ui/tabs.tsx
    client/src/App.tsx
  </files>
  <action>
    Add shadcn tabs component:
    ```bash
    cd client && npx shadcn@latest add tabs
    ```

    Create `client/src/components/cases/CaseMetadata.tsx`:
    - Props: case_ (Case object), onSave (callback receiving updated metadata dict)
    - Two modes: VIEW and EDIT (toggle with useState)
    - VIEW mode:
      - Displays metadata fields as a labeled key-value grid (2 columns)
      - Each field shows the property title (from audit_type.schema.properties[key].title) and value
      - Empty values show a muted "Not set" placeholder
      - "Edit" button in the top-right corner to switch to edit mode
    - EDIT mode:
      - Renders SchemaForm component with the audit type's schema and current metadata values
      - "Save" and "Cancel" buttons below the form
      - On Save: calls onSave with the updated metadata values, switches back to VIEW mode
      - On Cancel: discards changes, switches back to VIEW mode
    - Uses the audit_type from the case to get the schema for SchemaForm

    Create `client/src/pages/CaseDetailPage.tsx`:
    - Gets case ID from URL params (useParams from react-router)
    - Uses useCase(id) to fetch case data
    - Uses useUpdateCase() mutation for all updates
    - Uses useDeleteCase() mutation for deletion

    **Page layout:**
    - Header: Back arrow/link to case list, case title (editable inline -- click to edit, blur/enter to save), case number badge (#N)
    - Below header: Flex row with LifecycleControl on the left, AssigneeSelect on the right

    **Tabs (using shadcn Tabs):**
    - Tab "Overview" (default active):
      - Case info section: title (editable), description (editable textarea, click to edit)
      - CaseMetadata component for inline metadata editing
      - Case details: created by, created at, updated at (read-only info)
    - Tab "Timeline" (placeholder for Phase 3):
      - Simple message: "Timeline will be available in a future update"
      - This tab establishes the navigation pattern for Phase 3

    **Inline editing pattern:**
    - Title: Click text to show input, press Enter or blur to save (calls useUpdateCase with {title: newTitle})
    - Description: Click text to show textarea, Save/Cancel buttons to confirm (calls useUpdateCase with {description: newDescription})
    - Metadata: Uses CaseMetadata component which calls useUpdateCase with {metadata: newMetadata}
    - Status: LifecycleControl calls useUpdateCase with {status: newStatus}
    - Assignment: AssigneeSelect calls useUpdateCase with {assigned_to_id: newId}

    **Delete functionality:**
    - "Delete Case" button (destructive variant) at the bottom of Overview tab
    - Opens a Dialog confirmation: "Are you sure you want to delete this case? This action cannot be undone."
    - Confirm button calls useDeleteCase mutation, on success navigates to /

    **Loading/error states:**
    - Show loading spinner while case is being fetched
    - Show error message if case fetch fails or returns 404
    - Show toast or inline feedback when updates succeed/fail (simple -- can use a state message that auto-clears)

    Update `client/src/App.tsx`:
    - Ensure route `/cases/:id` points to CaseDetailPage (replace placeholder from 02-04 if it was a placeholder)
    - Import CaseDetailPage
  </action>
  <verify>
    - `cd client && pnpm build` succeeds
    - `cd client && npx tsc --noEmit` passes
    - CaseDetailPage.tsx exists and contains tabs, metadata editing, lifecycle, and assignment
    - App.tsx has /cases/:id route pointing to CaseDetailPage
  </verify>
  <done>CaseDetailPage displays full case info with tabs, inline editable title/description/metadata, lifecycle state controls, assignee selection, and delete with confirmation.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete case management flow</name>
  <files>None (verification only)</files>
  <action>
    Human verification checkpoint. What was built: Complete case management system -- schema registry, CRUD API, case creation with dynamic forms, filterable case list, and case detail with inline editing, lifecycle controls, and assignment.

    Prerequisites: Docker stack must be running (docker compose up -d).

    Steps to verify:
    1. Navigate to the app in the browser (http://localhost)
    2. Log in with admin/changeme
    3. Verify the case list page is the default view (should show empty state with "New Case" button)
    4. Click "New Case" to navigate to /cases/new
    5. Select "USB Usage" audit type -- verify S/N, User Name, User ID, Computer Used fields appear
    6. Switch to "Email Usage" -- verify Email Address, Email Server, Account Owner, Department fields appear
    7. Fill in the USB form: title "Test USB Case", fill all metadata fields, submit
    8. Verify redirect to case list with the new case visible
    9. Click the case row to open the detail view
    10. Verify metadata is displayed in the Overview tab
    11. Click "Edit" on metadata, change a field, save -- verify the update persists
    12. Change status from Open to Active using the lifecycle control
    13. Assign the case to the admin user
    14. Test the delete flow: click Delete, confirm in dialog, verify redirect to empty case list
    15. Verify the Timeline tab shows placeholder text

    Resume signal: Type "approved" or describe issues to fix.
  </action>
  <verify>All 15 verification steps pass successfully in the browser.</verify>
  <done>Complete Phase 2 case management flow verified end-to-end: create, edit, filter, lifecycle, assign, delete.</done>
</task>

</tasks>

<verification>
- Users endpoint returns active users for assignment dropdown
- CaseDetailPage loads and displays all case information
- Inline editing works for title, description, and metadata
- LifecycleControl shows correct transitions and updates status
- AssigneeSelect shows all active users and updates assignment
- Delete dialog requires confirmation before deleting
- Tabs component renders Overview and Timeline tabs
- All routes work correctly: / (list), /cases/new (create), /cases/:id (detail)
- Client builds without errors
- Full CRUD flow works end-to-end
</verification>

<success_criteria>
1. User can view full case details on /cases/:id (CASE-01)
2. User can edit case metadata inline without page navigation (CASE-03)
3. User can delete a case with confirmation (CASE-04)
4. User can change lifecycle state with valid transitions enforced (CASE-05)
5. User can assign a case to a team member (CASE-07)
6. Tab navigation works with Overview active and Timeline as placeholder
7. All requirements CASE-01 through CASE-07 are fulfilled
</success_criteria>

<output>
After completion, create `.planning/phases/02-audit-schemas-cases/02-05-SUMMARY.md`
</output>
