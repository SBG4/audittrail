# Phase 7: Report Generation - PDF & DOCX - Research

**Researched:** 2026-02-10
**Domain:** Document generation (PDF + DOCX) from structured audit data
**Confidence:** HIGH

## Summary

Phase 7 adds professional report generation to AuditTrail in both PDF and DOCX formats. Reports come in two modes: "quick timeline" (case summary + chronological events table) and "detailed narrative" (findings, conclusions, recommendations sections). The standard approach uses Jinja2 for HTML templating, WeasyPrint to render HTML/CSS to PDF, and python-docx for native DOCX generation. A shared data collection pipeline feeds both renderers.

The architecture is straightforward: a report data service collects case + events + file batches into a unified data structure, Jinja2 templates render that data into styled HTML, WeasyPrint converts HTML to PDF, and python-docx builds DOCX documents programmatically. The frontend provides format/mode selection and triggers download via a streaming response.

**Primary recommendation:** Use Jinja2 + WeasyPrint for PDF and python-docx for DOCX. Share a common data collection pipeline. Templates should be server-side files (not user-editable).

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| WeasyPrint | >=68.0 | HTML/CSS to PDF rendering | Industry standard Python HTML-to-PDF, supports CSS3 flexbox/grid, page breaks, headers/footers |
| python-docx | >=1.2.0 | Native DOCX document creation | Only serious Python library for .docx creation, supports tables, styles, paragraphs |
| Jinja2 | >=3.1.0 | HTML template rendering | Already a FastAPI/Starlette dependency, battle-tested template engine |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| (none needed) | - | Jinja2 is already bundled with FastAPI/Starlette | - |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| WeasyPrint | reportlab | reportlab is more low-level, requires manual PDF construction; WeasyPrint lets us use HTML/CSS |
| WeasyPrint | wkhtmltopdf | Requires external binary, headless WebKit; WeasyPrint is pure Python+C |
| python-docx | docxtpl | docxtpl uses template .docx files with Jinja2 syntax; adds complexity vs programmatic approach |

**Installation:**
```bash
uv add weasyprint python-docx
```

Note: WeasyPrint requires system libraries (pango, cairo, gdk-pixbuf). In Docker, install via: `apt-get install -y libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf-2.0-0 libcairo2 libffi-dev`

## Architecture Patterns

### Recommended Project Structure
```
server/src/
├── services/
│   └── report_generator.py     # Data collection + PDF/DOCX rendering
├── routers/
│   └── reports.py              # GET /cases/{id}/reports/pdf, /reports/docx
├── schemas/
│   └── report.py               # ReportRequest schema (mode, format)
└── templates/
    └── reports/
        ├── base.html           # Base layout with CSS
        ├── timeline.html       # Quick timeline mode
        └── narrative.html      # Detailed narrative mode
```

### Pattern 1: Report Data Collection Pipeline
**What:** Single function that fetches case + audit type + events + file batches and returns a unified dict for templates.
**When to use:** Always -- both PDF and DOCX renderers consume the same data.

### Pattern 2: Jinja2 + WeasyPrint PDF Pipeline
**What:** Render Jinja2 HTML template with data, then pass HTML string to WeasyPrint to produce PDF bytes.
**When to use:** For all PDF generation.
```python
from jinja2 import Environment, FileSystemLoader
from weasyprint import HTML

env = Environment(loader=FileSystemLoader("src/templates"))
template = env.get_template("reports/timeline.html")
html_string = template.render(**report_data)
pdf_bytes = HTML(string=html_string).write_pdf()
```

### Pattern 3: python-docx Programmatic Document Building
**What:** Build DOCX document by adding paragraphs, tables, and styled runs programmatically.
**When to use:** For all DOCX generation.
```python
from docx import Document
from docx.shared import Inches, Pt, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH

doc = Document()
doc.add_heading("Case Report", level=0)
doc.add_paragraph("Case #123: USB Usage Investigation")
table = doc.add_table(rows=1, cols=4, style="Table Grid")
# Add header row, data rows...
```

### Pattern 4: StreamingResponse for File Downloads
**What:** Return generated bytes as StreamingResponse with appropriate Content-Type and Content-Disposition headers.
**When to use:** For all report download endpoints.
```python
from fastapi.responses import StreamingResponse
import io

return StreamingResponse(
    io.BytesIO(pdf_bytes),
    media_type="application/pdf",
    headers={"Content-Disposition": f"attachment; filename=report.pdf"}
)
```

### Anti-Patterns to Avoid
- **Building HTML strings manually:** Always use Jinja2 templates, never string concatenation
- **Synchronous WeasyPrint in async endpoint:** WeasyPrint is CPU-bound; use run_in_executor for async FastAPI endpoints
- **Storing reports in database:** Generate on-demand, don't persist (they can always be regenerated)

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| PDF pagination | Custom page break logic | WeasyPrint CSS `page-break-before/after` | CSS handles this natively |
| DOCX table formatting | Manual XML manipulation | python-docx Table styles | python-docx abstracts OpenXML |
| Template rendering | String concatenation/f-strings | Jinja2 templates | Escaping, loops, conditionals, includes |
| Date formatting in templates | Custom Python formatters | Jinja2 filters | `{{ date \| format_date }}` pattern |

## Common Pitfalls

### Pitfall 1: WeasyPrint System Dependencies in Docker
**What goes wrong:** WeasyPrint fails to import without system libraries (pango, cairo).
**Why it happens:** WeasyPrint wraps C libraries for text layout and rendering.
**How to avoid:** Add `apt-get install` in Dockerfile: libpango-1.0-0 libpangocairo-1.0-0 libgdk-pixbuf-2.0-0 libcairo2 libffi-dev
**Warning signs:** ImportError or "cannot find library" at startup.

### Pitfall 2: Blocking Event Loop with WeasyPrint
**What goes wrong:** PDF generation blocks the async event loop, causing timeouts for other requests.
**Why it happens:** WeasyPrint is CPU-bound, not async.
**How to avoid:** Use `asyncio.get_event_loop().run_in_executor(None, generate_pdf)` to run in thread pool.
**Warning signs:** Other endpoints become slow during PDF generation.

### Pitfall 3: python-docx Table Cell Paragraphs
**What goes wrong:** Table cells always contain a default empty paragraph, causing extra spacing.
**Why it happens:** python-docx adds a default paragraph to each cell.
**How to avoid:** Use `cell.paragraphs[0]` instead of `cell.add_paragraph()` for the first content.
**Warning signs:** Extra blank lines in table cells.

### Pitfall 4: CSS @page Not Rendering in WeasyPrint
**What goes wrong:** Page margins, headers, footers don't appear.
**Why it happens:** @page CSS rules have specific syntax requirements.
**How to avoid:** Use `@page { margin: 2cm; @top-center { content: "Title"; } }` syntax.
**Warning signs:** Page numbers or headers missing from PDF.

## Code Examples

### WeasyPrint PDF Generation
```python
from weasyprint import HTML
from jinja2 import Environment, FileSystemLoader
import asyncio
from functools import partial

env = Environment(loader=FileSystemLoader("src/templates"))

def generate_pdf_sync(template_name: str, data: dict) -> bytes:
    template = env.get_template(template_name)
    html_string = template.render(**data)
    return HTML(string=html_string, base_url="src/templates/").write_pdf()

async def generate_pdf(template_name: str, data: dict) -> bytes:
    loop = asyncio.get_event_loop()
    return await loop.run_in_executor(
        None, partial(generate_pdf_sync, template_name, data)
    )
```

### python-docx Document Building
```python
from docx import Document
from docx.shared import Pt, Inches, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.table import WD_TABLE_ALIGNMENT

doc = Document()

# Title
title = doc.add_heading("Audit Case Report", level=0)
title.alignment = WD_ALIGN_PARAGRAPH.CENTER

# Case info table
table = doc.add_table(rows=4, cols=2, style="Table Grid")
fields = [("Case #", "123"), ("Type", "USB Usage"), ("Status", "Active"), ("Assignee", "John")]
for i, (label, value) in enumerate(fields):
    table.rows[i].cells[0].paragraphs[0].text = label
    table.rows[i].cells[1].paragraphs[0].text = value

# Events timeline table
doc.add_heading("Timeline", level=1)
events_table = doc.add_table(rows=1, cols=5, style="Table Grid")
headers = ["Date", "Time", "Type", "File Name", "Description"]
for i, header in enumerate(headers):
    cell = events_table.rows[0].cells[i]
    cell.paragraphs[0].text = header
    run = cell.paragraphs[0].runs[0]
    run.bold = True

# Save to bytes
import io
buffer = io.BytesIO()
doc.save(buffer)
buffer.seek(0)
docx_bytes = buffer.getvalue()
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| reportlab low-level PDF | WeasyPrint HTML/CSS-to-PDF | ~2020 | Much easier to maintain templates |
| wkhtmltopdf (WebKit) | WeasyPrint (pure Python+C) | ~2021 | No external binary dependency |
| python-docx 0.x | python-docx 1.2.0 | 2025 | Stable API, better type hints |

## Open Questions

1. **Font embedding for airgap** -- WeasyPrint can embed fonts from local files. Need to bundle a professional font (e.g., Liberation Sans/Serif) in the Docker image. Not a blocker but should be handled in the Dockerfile.

## Sources

### Primary (HIGH confidence)
- WeasyPrint PyPI: https://pypi.org/project/weasyprint/ -- version 68.1, BSD license
- python-docx docs: https://python-docx.readthedocs.io/ -- version 1.2.0, table/style API
- Jinja2 (bundled with Starlette/FastAPI)

### Secondary (MEDIUM confidence)
- WeasyPrint + Jinja2 patterns: https://joshkaramuth.com/blog/generate-good-looking-pdfs-weasyprint-jinja2/
- WeasyPrint changelog: https://doc.courtbouillon.org/weasyprint/stable/changelog.html

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - well-established libraries, latest versions verified on PyPI
- Architecture: HIGH - common Jinja2 + WeasyPrint + python-docx pattern widely documented
- Pitfalls: HIGH - system dependency issues and async blocking are well-known

**Research date:** 2026-02-10
**Valid until:** 2026-03-10 (30 days - stable domain)
