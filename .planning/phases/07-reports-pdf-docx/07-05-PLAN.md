---
phase: 07-reports-pdf-docx
plan: 05
type: execute
wave: 4
depends_on: ["07-03", "07-04"]
files_modified:
  - client/src/types/report.ts
  - client/src/hooks/useReports.ts
  - client/src/components/reports/ReportDialog.tsx
  - client/src/pages/CaseDetailPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can open a report generation dialog from the case detail page"
    - "User can select report format (PDF or DOCX) and mode (timeline or narrative)"
    - "User can download the generated report file"
  artifacts:
    - path: "client/src/types/report.ts"
      provides: "Report TypeScript types"
    - path: "client/src/hooks/useReports.ts"
      provides: "Report generation hook with download"
    - path: "client/src/components/reports/ReportDialog.tsx"
      provides: "Report generation dialog component"
  key_links:
    - from: "client/src/pages/CaseDetailPage.tsx"
      to: "client/src/components/reports/ReportDialog.tsx"
      via: "Dialog trigger button in case header"
    - from: "client/src/hooks/useReports.ts"
      to: "/api/cases/{id}/reports/generate"
      via: "fetch with blob download"
---

<objective>
Build the frontend UI for report generation with format/mode selection and file download.

Purpose: Give auditors a simple interface to generate and download reports from the case detail page.
Output: Report dialog component, download hook, integration in CaseDetailPage.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-reports-pdf-docx/07-01-SUMMARY.md
@client/src/pages/CaseDetailPage.tsx
@client/src/lib/api.ts
@client/src/hooks/useEvents.ts
@client/src/types/case.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report types and download hook</name>
  <files>client/src/types/report.ts, client/src/hooks/useReports.ts</files>
  <action>
Create client/src/types/report.ts:
- export type ReportFormat = "pdf" | "docx"
- export type ReportMode = "timeline" | "narrative"
- export interface ReportRequest { format: ReportFormat; mode: ReportMode; }

Create client/src/hooks/useReports.ts:
- Import useMutation from @tanstack/react-query
- Create function downloadReport(caseId: string, format: ReportFormat, mode: ReportMode):
  - Build URL: `/api/cases/${caseId}/reports/generate?format=${format}&mode=${mode}`
  - Get token from localStorage
  - Use fetch() directly (not api helper -- need blob response, not JSON):
    - method: "GET"
    - headers: { Authorization: `Bearer ${token}` }
  - Check response.ok, throw Error if not
  - Get blob from response.blob()
  - Extract filename from Content-Disposition header, fallback to `report.${format}`
  - Create object URL from blob
  - Create temporary <a> element, set href to object URL, set download to filename
  - Click the link programmatically to trigger download
  - Revoke object URL after download
- Export useGenerateReport(caseId: string) hook:
  - Return useMutation wrapping downloadReport
  - mutationFn receives { format, mode } and calls downloadReport(caseId, format, mode)
  </action>
  <verify>`test -f /Users/shiro/projec1/client/src/types/report.ts && test -f /Users/shiro/projec1/client/src/hooks/useReports.ts && echo "OK"`</verify>
  <done>Report types defined. useGenerateReport hook handles blob download with auth headers.</done>
</task>

<task type="auto">
  <name>Task 2: Report dialog component and CaseDetailPage integration</name>
  <files>client/src/components/reports/ReportDialog.tsx, client/src/pages/CaseDetailPage.tsx</files>
  <action>
Create client/src/components/reports/ directory.

Create client/src/components/reports/ReportDialog.tsx:
- Props: caseId: string, caseNumber: number, open: boolean, onOpenChange: (open: boolean) => void
- State: format (ReportFormat, default "pdf"), mode (ReportMode, default "timeline")
- Use useGenerateReport hook
- Render Dialog (from shadcn/ui) with:
  - DialogHeader: "Generate Report"
  - DialogDescription: "Select format and mode for case #{caseNumber}"
  - Format selection: two buttons/cards side by side (PDF, DOCX)
    - Use Button with variant="outline" for unselected, variant="default" for selected
    - PDF button label: "PDF" with file icon
    - DOCX button label: "DOCX" with file icon
  - Mode selection: two buttons/cards side by side (Timeline, Narrative)
    - Timeline: "Quick Timeline" -- "Case summary with chronological events"
    - Narrative: "Detailed Narrative" -- "Findings, conclusions, and recommendations"
  - Generate button:
    - Label: "Generate & Download" (or "Generating..." when isPending)
    - Disabled when isPending
    - OnClick: call generateReport.mutate({ format, mode })
  - Show error message if mutation.isError
  - On success: close dialog (onOpenChange(false))

Update client/src/pages/CaseDetailPage.tsx:
- Import ReportDialog and FileText icon from lucide-react
- Add state: reportDialogOpen (boolean, default false)
- Add a "Generate Report" button in the case header area (next to the case title/badge area):
  - Use Button variant="outline" with FileText icon
  - Label: "Generate Report"
  - OnClick: setReportDialogOpen(true)
- Render ReportDialog component with caseId={id}, caseNumber={case_.case_number}, open={reportDialogOpen}, onOpenChange={setReportDialogOpen}
  </action>
  <verify>`test -f /Users/shiro/projec1/client/src/components/reports/ReportDialog.tsx && echo "OK"`</verify>
  <done>ReportDialog renders format/mode selection with download. CaseDetailPage has "Generate Report" button triggering the dialog.</done>
</task>

</tasks>

<verification>
- Report dialog shows format (PDF/DOCX) and mode (timeline/narrative) selection
- Download hook uses blob fetch with auth headers
- CaseDetailPage has "Generate Report" button
- Dialog closes on successful generation
</verification>

<success_criteria>
- User can click "Generate Report" on case detail page
- User can select PDF or DOCX format
- User can select Timeline or Narrative mode
- Clicking "Generate & Download" triggers a file download
- Download uses correct auth headers
</success_criteria>

<output>
After completion, create `.planning/phases/07-reports-pdf-docx/07-05-SUMMARY.md`
</output>
