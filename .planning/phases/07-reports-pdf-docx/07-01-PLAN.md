---
phase: 07-reports-pdf-docx
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/services/report_generator.py
  - server/src/schemas/report.py
  - server/src/routers/reports.py
  - server/src/main.py
autonomous: true

must_haves:
  truths:
    - "Report data collection returns complete case data with audit type, events, and file batches"
    - "Report endpoint accepts case_id, format (pdf/docx), and mode (timeline/narrative) parameters"
    - "Report router is registered in FastAPI app"
  artifacts:
    - path: "server/src/services/report_generator.py"
      provides: "Report data collection pipeline"
    - path: "server/src/schemas/report.py"
      provides: "Report request/response schemas"
    - path: "server/src/routers/reports.py"
      provides: "Report generation endpoints"
  key_links:
    - from: "server/src/routers/reports.py"
      to: "server/src/services/report_generator.py"
      via: "collect_report_data function call"
    - from: "server/src/main.py"
      to: "server/src/routers/reports.py"
      via: "app.include_router"
---

<objective>
Build the report data collection pipeline and API endpoint skeleton for report generation.

Purpose: Establish the shared data layer that both PDF and DOCX renderers will consume, and the API endpoint that clients will call.
Output: Report service with collect_report_data(), Pydantic schemas, router with GET endpoint.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@server/src/models/case.py
@server/src/models/event.py
@server/src/models/file_batch.py
@server/src/models/audit_type.py
@server/src/schemas/case.py
@server/src/schemas/event.py
@server/src/routers/cases.py
@server/src/deps.py
@server/src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report schemas and data collection service</name>
  <files>server/src/schemas/report.py, server/src/services/report_generator.py</files>
  <action>
Create server/src/schemas/report.py with:
- ReportFormat enum: "pdf", "docx"
- ReportMode enum: "timeline", "narrative"
- ReportRequest schema: format (ReportFormat), mode (ReportMode)
- ReportData dataclass/schema containing all data needed for rendering:
  - case info (case_number, title, description, status, created_at, updated_at)
  - audit_type info (name, slug)
  - metadata dict
  - assigned_to name (string or None)
  - created_by name (string)
  - events list (each with: event_date, event_time, event_type, file_name, file_count, file_description, file_type, file_batches list)
  - file_batches within each event (label, file_count, description, file_types)
  - generated_at datetime
  - generated_by username

Create server/src/services/report_generator.py with:
- async function collect_report_data(case_id: UUID, db: AsyncSession, current_user: User) -> dict
  - Fetch case with relationships (audit_type, assigned_to, created_by) using selectinload
  - Raise 404 if case not found
  - Fetch all events for the case ordered by event_date, event_time, sort_order
  - Use selectinload for event.file_batches and event.created_by
  - Build and return a dict with all report data, formatted for template consumption
  - Format dates as strings (YYYY-MM-DD), times as HH:MM, datetimes as human-readable
  - Include generated_at (now) and generated_by (current_user.full_name)
  </action>
  <verify>Python syntax check: `cd /Users/shiro/projec1/server && python -c "from src.schemas.report import ReportFormat, ReportMode; from src.services.report_generator import collect_report_data; print('OK')"`</verify>
  <done>Report schemas define format/mode enums. collect_report_data fetches case+events+batches into template-ready dict.</done>
</task>

<task type="auto">
  <name>Task 2: Report router with download endpoint</name>
  <files>server/src/routers/reports.py, server/src/main.py</files>
  <action>
Create server/src/routers/reports.py with:
- Router prefix: /cases/{case_id}/reports, tags: ["reports"]
- GET /cases/{case_id}/reports/generate endpoint:
  - Query params: format (str, "pdf" or "docx"), mode (str, "timeline" or "narrative")
  - Depends on get_db, get_current_user
  - Calls collect_report_data to get the data dict
  - For now, return a placeholder JSON response with the data dict (PDF/DOCX rendering will be added in plans 07-03 and 07-04)
  - Will be updated in 07-03/07-04 to return StreamingResponse with actual file bytes
  - Validate format is "pdf" or "docx", mode is "timeline" or "narrative" -- raise 422 if invalid

Register the router in server/src/main.py:
- Import reports router
- Add app.include_router(reports_router)
  </action>
  <verify>Python syntax check: `cd /Users/shiro/projec1/server && python -c "from src.routers.reports import router; print('routes:', [r.path for r in router.routes])"`</verify>
  <done>Report router registered in app. GET endpoint validates params and calls collect_report_data. Returns placeholder response pending renderer integration.</done>
</task>

</tasks>

<verification>
- `cd /Users/shiro/projec1/server && python -c "from src.main import app; routes = [r.path for r in app.routes]; assert '/cases/{case_id}/reports/generate' in routes or any('reports' in str(r) for r in routes); print('Router registered')"`
- All imports resolve without errors
</verification>

<success_criteria>
- ReportFormat and ReportMode enums exist with correct values
- collect_report_data function fetches complete case data with events and file batches
- Report router is registered in the FastAPI app
- GET endpoint accepts format and mode query parameters
</success_criteria>

<output>
After completion, create `.planning/phases/07-reports-pdf-docx/07-01-SUMMARY.md`
</output>
