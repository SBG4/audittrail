---
phase: 07-reports-pdf-docx
plan: 04
type: execute
wave: 3
depends_on: ["07-01"]
files_modified:
  - server/src/services/report_generator.py
  - server/src/routers/reports.py
  - server/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "DOCX report can be generated with case summary, events table, and file batch details"
    - "DOCX timeline mode shows case summary and chronological events table"
    - "DOCX narrative mode shows findings, actions, notes sections plus full timeline"
    - "Report endpoint returns StreamingResponse with DOCX bytes and correct headers"
  artifacts:
    - path: "server/src/services/report_generator.py"
      provides: "generate_docx function using python-docx"
    - path: "server/src/routers/reports.py"
      provides: "Updated endpoint returning DOCX StreamingResponse"
  key_links:
    - from: "server/src/routers/reports.py"
      to: "server/src/services/report_generator.py"
      via: "generate_docx async function call"
---

<objective>
Add DOCX rendering using python-docx to generate Word documents matching the PDF report content.

Purpose: Enable DOCX report generation so auditors can edit reports in Word after generation.
Output: python-docx integration in report_generator.py, updated endpoint returning DOCX StreamingResponse.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-reports-pdf-docx/07-01-SUMMARY.md
@server/src/services/report_generator.py
@server/src/routers/reports.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: python-docx DOCX generation functions</name>
  <files>server/pyproject.toml, server/src/services/report_generator.py</files>
  <action>
Add python-docx to server/pyproject.toml dependencies:
- Add "python-docx>=1.1.0" to the dependencies list

Add DOCX generation to server/src/services/report_generator.py:
- Import: from docx import Document
- Import: from docx.shared import Pt, Inches, RGBColor, Cm
- Import: from docx.enum.text import WD_ALIGN_PARAGRAPH
- Import: from docx.enum.table import WD_TABLE_ALIGNMENT

Add helper function _style_table_header(table, num_cols):
  - Set header row cells to bold text
  - Set header background to dark color (RGB: 44, 62, 80 -- dark blue-gray)
  - Set header text color to white
  - Use cell.paragraphs[0].runs[0] pattern (not add_paragraph) to avoid extra spacing

Add helper function _add_metadata_table(doc, data):
  - Create 2-column table with "Table Grid" style
  - Add rows for: Case Number, Title, Audit Type, Status, Assigned To, Created By, Created At, Updated At
  - Add case metadata fields (from data["metadata"] dict, loop over key-value pairs)
  - Bold the label column

Add helper function _add_events_table(doc, events):
  - Create table with columns: Date, Time, Type, File Name, Count, Description
  - Style header row
  - Add one row per event
  - For events with file_batches, add sub-rows below the event row with indented batch details (label, count, file types, description)
  - Handle None values gracefully (show "" or "N/A")

Add sync function _generate_docx_timeline(data: dict) -> bytes:
  - Create Document()
  - Add title: "Audit Case Report" (heading level 0, centered)
  - Add subtitle: "Quick Timeline" (heading level 1)
  - Add "Case Summary" heading (level 2)
  - Call _add_metadata_table
  - If description exists, add "Description" heading and paragraph
  - Add "Timeline Events" heading (level 2)
  - Call _add_events_table
  - Add footer paragraph: "Generated on {date} by {user}"
  - Save to io.BytesIO, return bytes

Add sync function _generate_docx_narrative(data: dict) -> bytes:
  - Create Document()
  - Add title: "Audit Case Report" (heading level 0, centered)
  - Add subtitle: "Detailed Narrative" (heading level 1)
  - Add "Executive Summary" heading (level 2)
    - Auto-generated paragraph: "This report covers audit case #{case_number} ({title}), spanning {event_count} events from {first_date} to {last_date}."
    - Key metrics: total events, total file count, date range
  - Add "Case Details" heading (level 2)
  - Call _add_metadata_table
  - Add "Findings" heading (level 2)
    - Filter events with event_type == "finding"
    - Render each as numbered paragraph with date, file info, description, batches
    - If no findings: "No findings recorded."
  - Add "Actions Taken" heading (level 2)
    - Filter events with event_type == "action"
    - Same numbered format
    - If no actions: "No actions recorded."
  - Add "Supporting Notes" heading (level 2)
    - Filter events with event_type == "note"
    - Same numbered format
    - If no notes: "No notes recorded."
  - Add "Complete Timeline" heading (level 2)
  - Call _add_events_table (all events)
  - Add "Conclusions" heading (level 2)
    - Paragraph: "[Add conclusions here]"
  - Add "Recommendations" heading (level 2)
    - Paragraph: "[Add recommendations here]"
  - Add footer: "Generated on {date} by {user}"
  - Save to BytesIO, return bytes

Add async function generate_docx(mode: str, data: dict) -> bytes:
  - If mode == "timeline": run _generate_docx_timeline in executor
  - If mode == "narrative": run _generate_docx_narrative in executor
  - Return DOCX bytes
  </action>
  <verify>`cd /Users/shiro/projec1/server && python -c "from src.services.report_generator import generate_docx; print('OK')"`</verify>
  <done>generate_docx creates professional DOCX documents in both timeline and narrative modes.</done>
</task>

<task type="auto">
  <name>Task 2: Update report endpoint for DOCX download</name>
  <files>server/src/routers/reports.py</files>
  <action>
Update server/src/routers/reports.py:
- Import: generate_docx from services
- Update the GET /generate endpoint:
  - When format == "docx":
    - Call generate_docx(mode=mode, data=report_data)
    - Build filename: f"case-{case_number}-{mode}-report.docx"
    - Return StreamingResponse with:
      - io.BytesIO(docx_bytes) as content
      - media_type="application/vnd.openxmlformats-officedocument.wordprocessingml.document"
      - headers={"Content-Disposition": f'attachment; filename="{filename}"'}
  </action>
  <verify>`cd /Users/shiro/projec1/server && python -c "from src.routers.reports import router; print('OK')"`</verify>
  <done>DOCX format requests return StreamingResponse with DOCX bytes and correct content type.</done>
</task>

</tasks>

<verification>
- python-docx added to pyproject.toml dependencies
- generate_docx function handles both timeline and narrative modes
- DOCX includes case summary, events table, and file batch details
- Report endpoint returns correct MIME type for DOCX
</verification>

<success_criteria>
- python-docx is a declared dependency
- Timeline mode DOCX has case summary + events table
- Narrative mode DOCX has findings/actions/notes sections + full timeline
- GET endpoint returns DOCX bytes with correct Content-Type and Content-Disposition headers
</success_criteria>

<output>
After completion, create `.planning/phases/07-reports-pdf-docx/07-04-SUMMARY.md`
</output>
