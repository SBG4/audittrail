---
phase: 07-reports-pdf-docx
plan: 03
type: execute
wave: 3
depends_on: ["07-01", "07-02"]
files_modified:
  - server/src/services/report_generator.py
  - server/src/routers/reports.py
  - server/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "PDF report can be generated from HTML template using WeasyPrint"
    - "PDF generation runs in thread pool executor to avoid blocking async event loop"
    - "Report endpoint returns StreamingResponse with PDF bytes and correct headers"
  artifacts:
    - path: "server/src/services/report_generator.py"
      provides: "generate_pdf function using WeasyPrint"
    - path: "server/src/routers/reports.py"
      provides: "Updated endpoint returning PDF StreamingResponse"
  key_links:
    - from: "server/src/routers/reports.py"
      to: "server/src/services/report_generator.py"
      via: "generate_pdf async function call"
    - from: "server/src/services/report_generator.py"
      to: "server/src/templates/reports/"
      via: "Jinja2 Environment FileSystemLoader"
---

<objective>
Add PDF rendering using WeasyPrint to convert HTML templates into downloadable PDF reports.

Purpose: Enable PDF report generation, the primary output format for audit reports.
Output: WeasyPrint integration in report_generator.py, updated endpoint returning PDF StreamingResponse.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/07-reports-pdf-docx/07-01-SUMMARY.md
@.planning/phases/07-reports-pdf-docx/07-02-SUMMARY.md
@server/src/services/report_generator.py
@server/src/routers/reports.py
@server/src/templates/reports/base.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: WeasyPrint PDF generation function</name>
  <files>server/pyproject.toml, server/src/services/report_generator.py</files>
  <action>
Add weasyprint to server/pyproject.toml dependencies:
- Add "weasyprint>=68.0" to the dependencies list

Update server/src/services/report_generator.py to add PDF generation:
- Import: from jinja2 import Environment, FileSystemLoader
- Import: from weasyprint import HTML
- Import: import asyncio, from pathlib import Path, from functools import partial
- Create Jinja2 Environment with FileSystemLoader pointing to "src/templates" (relative to server root)
- Add custom Jinja2 filters:
  - format_date: format date objects as "YYYY-MM-DD"
  - format_time: format time objects as "HH:MM" or "N/A" if None
  - format_datetime: format datetime as "YYYY-MM-DD HH:MM"
- Add function get_template_name(mode: str) -> str:
  - "timeline" -> "reports/timeline.html"
  - "narrative" -> "reports/narrative.html"
- Add sync function _generate_pdf_sync(template_name: str, data: dict) -> bytes:
  - Get template from Jinja2 environment
  - Render HTML string with data
  - Create WeasyPrint HTML object with string=html_string and base_url pointing to templates directory (for relative CSS/image paths if any)
  - Return HTML.write_pdf() bytes
- Add async function generate_pdf(mode: str, data: dict) -> bytes:
  - Get template name from mode
  - Run _generate_pdf_sync in executor using asyncio.get_event_loop().run_in_executor(None, partial(...))
  - Return PDF bytes
  </action>
  <verify>`cd /Users/shiro/projec1/server && python -c "from src.services.report_generator import generate_pdf, collect_report_data; print('OK')"`</verify>
  <done>generate_pdf async function renders Jinja2 template and converts to PDF via WeasyPrint in thread pool.</done>
</task>

<task type="auto">
  <name>Task 2: Update report endpoint for PDF download</name>
  <files>server/src/routers/reports.py</files>
  <action>
Update server/src/routers/reports.py:
- Import: from fastapi.responses import StreamingResponse
- Import: import io
- Import: generate_pdf from services
- Update the GET /generate endpoint:
  - When format == "pdf":
    - Call generate_pdf(mode=mode, data=report_data)
    - Build filename: f"case-{case_number}-{mode}-report.pdf"
    - Return StreamingResponse with:
      - io.BytesIO(pdf_bytes) as content
      - media_type="application/pdf"
      - headers={"Content-Disposition": f'attachment; filename="{filename}"'}
  - When format == "docx":
    - Keep placeholder response for now (will be implemented in 07-04)
    - Return JSON with message "DOCX generation not yet implemented"
  </action>
  <verify>`cd /Users/shiro/projec1/server && python -c "from src.routers.reports import router; print('OK')"`</verify>
  <done>PDF format requests return StreamingResponse with PDF bytes. DOCX remains placeholder.</done>
</task>

</tasks>

<verification>
- WeasyPrint added to pyproject.toml dependencies
- generate_pdf function is async and uses run_in_executor
- Jinja2 Environment created with correct template path
- Report endpoint returns StreamingResponse for PDF format
</verification>

<success_criteria>
- WeasyPrint is a declared dependency
- PDF generation uses async wrapper around sync WeasyPrint call
- Jinja2 templates are loaded from server/src/templates directory
- GET endpoint returns PDF bytes with correct Content-Type and Content-Disposition headers
</success_criteria>

<output>
After completion, create `.planning/phases/07-reports-pdf-docx/07-03-SUMMARY.md`
</output>
