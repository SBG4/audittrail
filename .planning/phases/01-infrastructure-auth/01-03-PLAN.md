---
phase: 01-infrastructure-auth
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - client/src/main.tsx
  - client/src/App.tsx
  - client/src/app.css
  - client/src/lib/api.ts
  - client/src/stores/authStore.ts
  - client/src/hooks/useAuth.ts
  - client/src/pages/LoginPage.tsx
  - client/src/pages/DashboardPage.tsx
  - client/src/components/AuthGuard.tsx
  - client/src/components/Layout.tsx
  - client/package.json
autonomous: true

must_haves:
  truths:
    - "Login page renders with username and password fields and a submit button"
    - "Submitting valid credentials stores JWT in localStorage and redirects to dashboard"
    - "Submitting invalid credentials shows an error message on the login page"
    - "Navigating to a protected route without auth redirects to /login"
    - "Refreshing the browser while authenticated keeps the user logged in (JWT in localStorage)"
    - "Clicking logout clears the JWT and redirects to /login"
    - "Layout shell shows a header with app name and logout button on authenticated pages"
  artifacts:
    - path: "client/src/stores/authStore.ts"
      provides: "Zustand auth store with token, user, login, logout"
      contains: "create"
    - path: "client/src/lib/api.ts"
      provides: "Fetch wrapper that attaches JWT Bearer header"
      contains: "Authorization"
    - path: "client/src/pages/LoginPage.tsx"
      provides: "Login form with username, password, submit, error display"
      contains: "login"
    - path: "client/src/components/AuthGuard.tsx"
      provides: "Route wrapper that redirects unauthenticated users to /login"
      contains: "Navigate"
    - path: "client/src/components/Layout.tsx"
      provides: "App shell with header, nav, logout, and content outlet"
      contains: "Outlet"
    - path: "client/src/App.tsx"
      provides: "React Router setup with public and protected routes"
      contains: "BrowserRouter"
  key_links:
    - from: "client/src/pages/LoginPage.tsx"
      to: "client/src/stores/authStore.ts"
      via: "useAuthStore().login() call on form submit"
      pattern: "useAuthStore"
    - from: "client/src/stores/authStore.ts"
      to: "client/src/lib/api.ts"
      via: "api.post for login request"
      pattern: "api\\."
    - from: "client/src/lib/api.ts"
      to: "/api/auth/login"
      via: "fetch to backend auth endpoint"
      pattern: "/api/auth"
    - from: "client/src/components/AuthGuard.tsx"
      to: "client/src/stores/authStore.ts"
      via: "reads isAuthenticated from auth store"
      pattern: "useAuthStore"
    - from: "client/src/App.tsx"
      to: "client/src/components/AuthGuard.tsx"
      via: "wraps protected routes"
      pattern: "AuthGuard"
---

<objective>
Build the React SPA with login page, authentication state management, protected route guards, and the application layout shell. After this plan, the frontend has a working login form, JWT storage in localStorage, route protection, and a layout with logout capability.

Purpose: Provide the user-facing authentication UI that consumes the backend auth API (Plan 01-02). This completes the frontend side of the auth flow.

Output: React SPA with login page, Zustand auth store, AuthGuard component, Layout shell, and API client with JWT interceptor.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-infrastructure-auth/01-RESEARCH.md
@.planning/phases/01-infrastructure-auth/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: API client, Zustand auth store, and useAuth hook</name>
  <files>
    client/src/lib/api.ts
    client/src/stores/authStore.ts
    client/src/hooks/useAuth.ts
  </files>
  <action>
    1. Create `client/src/lib/api.ts` -- a fetch wrapper with JWT interceptor:
       - Export an `api` object with methods: `get(url)`, `post(url, body)`, `put(url, body)`, `delete(url)`
       - Each method calls `fetch()` with the full URL (e.g., `/api/auth/login`)
       - Automatically adds `Authorization: Bearer <token>` header if a token exists in localStorage (`localStorage.getItem("token")`)
       - For POST/PUT, set `Content-Type: application/json` and `JSON.stringify(body)`
       - Special handling for login: login uses `application/x-www-form-urlencoded` format (FastAPI's OAuth2PasswordRequestForm expects form data, not JSON)
       - On 401 response, clear token from localStorage and redirect to /login (optional -- can also let AuthGuard handle this)
       - Return parsed JSON response or throw error with status code

    2. Create `client/src/stores/authStore.ts` -- Zustand store for auth state:
       - State: `token: string | null`, `user: { id: string; username: string; fullName: string } | null`, `isAuthenticated: boolean`
       - Actions:
         - `login(username: string, password: string): Promise<void>` -- POST to `/api/auth/login` with form-encoded body (`username=...&password=...`), store token in localStorage AND in state, then fetch `/api/auth/me` to get user info and store in state
         - `logout(): void` -- remove token from localStorage, clear state, set isAuthenticated=false
         - `initialize(): void` -- check localStorage for existing token, if found set isAuthenticated=true and fetch /api/auth/me to hydrate user state. If /me returns 401, clear token and set isAuthenticated=false.
       - On store creation, call `initialize()` to restore auth state from localStorage on page load/refresh
       - Use `zustand` `create` function (NOT persist middleware -- we manually manage localStorage because we need the JWT token string, not serialized Zustand state)

    3. Create `client/src/hooks/useAuth.ts` -- convenience hook:
       - Re-export key selectors from authStore: `useAuth()` returns `{ isAuthenticated, user, login, logout, isLoading }`
       - `isLoading` tracks whether the initial `initialize()` has completed (prevents flash of login page on refresh)
  </action>
  <verify>
    `cd client && npx tsc --noEmit` -- no TypeScript errors.
    Verify `client/src/lib/api.ts` reads token from localStorage.
    Verify `client/src/stores/authStore.ts` calls localStorage.setItem on login and localStorage.removeItem on logout.
    Verify store initializes from localStorage on creation.
  </verify>
  <done>
    API client attaches JWT to requests, Zustand store manages auth state with login/logout/initialize, localStorage used for session persistence across browser refreshes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Login page, AuthGuard, Layout shell, and router setup</name>
  <files>
    client/src/pages/LoginPage.tsx
    client/src/pages/DashboardPage.tsx
    client/src/components/AuthGuard.tsx
    client/src/components/Layout.tsx
    client/src/App.tsx
    client/src/main.tsx
    client/src/app.css
  </files>
  <action>
    1. Install shadcn/ui for UI components:
       ```bash
       cd client
       npx shadcn@latest init --defaults
       ```
       Then add the components needed for the login form:
       ```bash
       npx shadcn@latest add button input label card
       ```

    2. Create `client/src/pages/LoginPage.tsx`:
       - Full-page centered login form using shadcn Card component
       - Fields: username (Input), password (Input type="password")
       - Submit button ("Sign In") that calls `login(username, password)` from useAuth
       - Error state: display error message (e.g., "Invalid credentials") below the form when login fails
       - Loading state: disable button and show "Signing in..." while request is in flight
       - If already authenticated, redirect to "/" using Navigate
       - Style: centered card on a gray background, "AuditTrail" title above the form

    3. Create `client/src/pages/DashboardPage.tsx`:
       - Simple placeholder page: "Welcome, {user.fullName}" heading
       - Brief text: "Dashboard coming in Phase 2"
       - This proves authentication works end-to-end

    4. Create `client/src/components/AuthGuard.tsx` per research Pattern 6:
       - Check `isAuthenticated` and `isLoading` from useAuth
       - If loading (initializing from localStorage), show a loading spinner or blank screen
       - If not authenticated and not loading, redirect to `/login` using `<Navigate to="/login" replace />`
       - If authenticated, render `children` (or `<Outlet />`)

    5. Create `client/src/components/Layout.tsx`:
       - App shell with header bar containing:
         - App name "AuditTrail" (left side)
         - User name display and "Logout" button (right side)
       - Use `<Outlet />` from react-router for page content
       - Logout button calls `logout()` from useAuth and navigates to /login
       - Style with Tailwind: white header with shadow, gray-50 body background, max-width content area

    6. Update `client/src/App.tsx` with React Router:
       ```tsx
       import { BrowserRouter, Routes, Route } from "react-router";
       // Routes:
       // /login -> LoginPage (public)
       // / -> AuthGuard > Layout > DashboardPage (protected)
       // Catch-all -> redirect to /
       ```
       Structure:
       - `<BrowserRouter>` wrapping `<Routes>`
       - Public route: `<Route path="/login" element={<LoginPage />} />`
       - Protected routes: `<Route element={<AuthGuard><Layout /></AuthGuard>}>`
         - `<Route index element={<DashboardPage />} />`
       - Fallback: `<Route path="*" element={<Navigate to="/" replace />} />`

    7. Update `client/src/main.tsx` to ensure `app.css` is imported (for Tailwind).

    8. Ensure `client/src/app.css` has `@import "tailwindcss";` at the top.
  </action>
  <verify>
    `cd client && pnpm build` succeeds without errors.
    `cd client && npx tsc --noEmit` -- no TypeScript errors.
    Verify `client/src/App.tsx` contains BrowserRouter, AuthGuard, Layout, LoginPage, DashboardPage routes.
    Verify `client/src/pages/LoginPage.tsx` has a form with username, password fields and submit button.
    Verify `client/src/components/AuthGuard.tsx` checks isAuthenticated and redirects to /login.
    Verify `client/src/components/Layout.tsx` has Outlet and logout button.
  </verify>
  <done>
    Login page with form validation and error display, AuthGuard protecting routes, Layout shell with header and logout, React Router setup with public/protected routes, Dashboard placeholder proving auth flow works.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` in client/ succeeds
2. No TypeScript errors (`npx tsc --noEmit`)
3. Login page has username field, password field, submit button
4. AuthGuard redirects unauthenticated users to /login
5. Layout shows header with app name and logout button
6. Routes configured: /login (public), / (protected dashboard)
7. Auth store persists token to localStorage and restores on initialize
</verification>

<success_criteria>
- Login page renders with username/password form
- Auth store manages JWT in localStorage
- AuthGuard prevents unauthenticated access
- Layout provides consistent app shell with logout
- React Router handles public and protected routes
- No TypeScript or build errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-infrastructure-auth/01-03-SUMMARY.md`
</output>
