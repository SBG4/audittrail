---
phase: 08-reports-html
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - server/src/services/html_report.py
  - server/src/routers/reports.py
  - server/src/main.py
autonomous: true

must_haves:
  truths:
    - "HTML report contains interactive Plotly timeline chart with hover, zoom, pan"
    - "HTML report contains dashboard statistics bar chart"
    - "Plotly.js is embedded in the HTML (no CDN reference)"
    - "Report is downloadable via API endpoint"
  artifacts:
    - path: "server/src/services/html_report.py"
      provides: "Chart generation methods using Plotly"
    - path: "server/src/routers/reports.py"
      provides: "Report download API endpoint"
  key_links:
    - from: "server/src/routers/reports.py"
      to: "server/src/services/html_report.py"
      via: "html_report_service.generate()"
    - from: "server/src/main.py"
      to: "server/src/routers/reports.py"
      via: "app.include_router(reports_router)"
---

<objective>
Add interactive Plotly chart generation to the HTML report service and create the API endpoint for report download.

Purpose: Charts are the key interactive feature of the HTML report (REPT-05). The API endpoint enables the frontend to trigger report generation and download.
Output: Plotly timeline chart, stats bar chart, and GET endpoint returning the HTML file.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-reports-html/08-RESEARCH.md
@.planning/phases/08-reports-html/08-01-SUMMARY.md
@server/src/services/html_report.py
@server/src/routers/cases.py
@server/src/deps.py
@server/src/main.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Plotly chart generation methods</name>
  <files>server/src/services/html_report.py</files>
  <action>
  Add chart generation methods to HtmlReportService:

  1. `def _generate_timeline_chart(self, events: list, case_title: str) -> str`:
     - Create a Plotly scatter/timeline chart showing events on a time axis
     - X-axis: event_date (date)
     - Y-axis: categorical labels by event_type ("Finding", "Action", "Note")
     - Marker colors by event_type: finding=#ef4444, action=#22c55e, note=#6366f1
     - Marker size: proportional to file_count (min 8, max 30, default 12)
     - Hover text: date, time, file_name, file_description (truncated to 100 chars)
     - Layout: title="Event Timeline", responsive, white background, no legend title
     - Chart config: displayModeBar=True, scrollZoom=True
     - Return fig.to_html(include_plotlyjs=True, full_html=False, div_id="timeline-chart", config={"displayModeBar": True, "scrollZoom": True})
     - IMPORTANT: First chart uses include_plotlyjs=True to embed the ~3MB plotly.js

  2. `def _generate_stats_chart(self, stats: dict) -> str`:
     - Create a Plotly bar chart showing events by type
     - X-axis: event types (Finding, Action, Note)
     - Y-axis: count
     - Bar colors matching timeline colors
     - Layout: title="Events by Type", compact height (300px)
     - Return fig.to_html(include_plotlyjs=False, full_html=False, div_id="stats-chart")
     - IMPORTANT: Subsequent charts use include_plotlyjs=False (already loaded by timeline chart)

  3. `def _generate_daily_activity_chart(self, stats: dict) -> str`:
     - Create a Plotly bar chart showing events by date
     - X-axis: dates
     - Y-axis: event count per date
     - Single color: #3b82f6 (blue)
     - Layout: title="Daily Activity", compact height (300px)
     - Return fig.to_html(include_plotlyjs=False, full_html=False, div_id="daily-chart")

  4. Update `render_html` to call chart generation methods and pass chart HTML to template:
     - timeline_chart_html = self._generate_timeline_chart(data["events"], data["case"].title)
     - stats_chart_html = self._generate_stats_chart(data["stats"])
     - daily_chart_html = self._generate_daily_activity_chart(data["stats"])
     - Pass all three to template.render()

  Handle edge cases:
  - If no events, generate empty chart with "No events recorded" annotation
  - If all events on same date, use scatter plot instead of timeline range
  </action>
  <verify>python -c "from src.services.html_report import html_report_service; print('Chart methods:', hasattr(html_report_service, '_generate_timeline_chart'))" from server directory</verify>
  <done>Three Plotly chart generation methods exist, timeline chart includes plotly.js, others skip it</done>
</task>

<task type="auto">
  <name>Task 2: Report API endpoint and router registration</name>
  <files>server/src/routers/reports.py, server/src/main.py</files>
  <action>
  1. Create server/src/routers/reports.py:
     - Router with prefix="/cases/{case_id}/reports", tags=["reports"]
     - GET /html endpoint:
       - Depends on get_db and get_current_user
       - Calls html_report_service.generate(case_id, db)
       - Returns StreamingResponse with content_type="text/html"
       - Sets Content-Disposition header: attachment; filename="audit-report-{case_number}.html"
       - Uses io.BytesIO to stream the HTML content encoded as UTF-8
     - Import StreamingResponse from fastapi.responses
     - Import html_report_service from src.services.html_report

  2. Update server/src/main.py:
     - Import reports router: from src.routers.reports import router as reports_router
     - Register: app.include_router(reports_router)
  </action>
  <verify>python -c "from src.routers.reports import router; print('Routes:', [r.path for r in router.routes])" from server directory</verify>
  <done>GET /cases/{case_id}/reports/html endpoint exists and returns StreamingResponse with HTML content</done>
</task>

</tasks>

<verification>
1. Timeline chart includes plotly.js (include_plotlyjs=True)
2. Stats and daily charts skip plotly.js (include_plotlyjs=False)
3. API endpoint returns HTML with Content-Disposition header
4. Router registered in main.py
</verification>

<success_criteria>
- Plotly timeline chart shows events by date with type-colored markers
- Plotly bar charts show events by type and daily activity
- Only one copy of plotly.js embedded in the HTML
- API endpoint at GET /cases/{case_id}/reports/html returns downloadable HTML
- Generated HTML contains interactive charts (hover, zoom, pan)
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-html/08-02-SUMMARY.md`
</output>
