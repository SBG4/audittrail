---
phase: 08-reports-html
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/pyproject.toml
  - server/src/services/html_report.py
  - server/src/templates/reports/html_report.html
  - server/src/schemas/report.py
autonomous: true

must_haves:
  truths:
    - "HTML report template renders a complete self-contained HTML document"
    - "All CSS is inlined in a style tag within the HTML"
    - "Report layout includes header, dashboard stats, timeline table, and footer sections"
  artifacts:
    - path: "server/src/templates/reports/html_report.html"
      provides: "Jinja2 HTML report template with inlined CSS"
    - path: "server/src/services/html_report.py"
      provides: "HTML report generation service"
    - path: "server/src/schemas/report.py"
      provides: "Report request/response Pydantic schemas"
  key_links:
    - from: "server/src/services/html_report.py"
      to: "server/src/templates/reports/html_report.html"
      via: "Jinja2 Environment template loading"
---

<objective>
Create the HTML report template with fully inlined CSS and the report generation service foundation, including the Jinja2 template, report data collection service, and Pydantic schemas.

Purpose: Establish the base HTML report infrastructure that subsequent plans will build upon (Plotly charts, asset inlining, optimization).
Output: Jinja2 template with complete layout, report service with data collection, Pydantic schemas for report API.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-reports-html/08-RESEARCH.md
@server/src/models/case.py
@server/src/models/event.py
@server/src/models/file_batch.py
@server/src/schemas/case.py
@server/src/schemas/event.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report Pydantic schemas and dependencies</name>
  <files>server/pyproject.toml, server/src/schemas/report.py</files>
  <action>
  1. Add `plotly>=5.18` and `jinja2>=3.1` to server/pyproject.toml dependencies.

  2. Create server/src/schemas/report.py with:
     - `ReportFormat` string enum: "html"
     - `ReportRequest` Pydantic model with fields: `format: ReportFormat`
     - `ReportResponse` Pydantic model with fields: `filename: str, content_type: str, size_bytes: int`
     - `DashboardStats` Pydantic model with fields: `total_events: int, total_file_batches: int, total_files: int, date_range_start: date | None, date_range_end: date | None, events_by_type: dict[str, int], events_by_date: dict[str, int]`
  </action>
  <verify>python -c "from src.schemas.report import ReportRequest, ReportResponse, DashboardStats; print('OK')" from server directory</verify>
  <done>Report schemas importable and contain all required fields</done>
</task>

<task type="auto">
  <name>Task 2: Jinja2 HTML report template with inlined CSS</name>
  <files>server/src/templates/reports/html_report.html</files>
  <action>
  Create server/src/templates/reports/html_report.html as a Jinja2 template.

  The template must be a complete HTML5 document with ALL CSS inlined in a single style tag. No external stylesheets, no external fonts, no external URLs of any kind.

  Template structure:
  - DOCTYPE html with lang="en"
  - Head: meta charset, viewport, title "{{ case.title }} - Audit Report"
  - Single `<style>` block with all CSS:
    - CSS reset/normalize (minimal)
    - System font stack: font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif
    - Color scheme: professional audit report (dark header, white body, subtle borders)
    - Print-friendly styles via @media print
    - Layout: max-width 1200px centered container
    - Responsive: works on screens from 768px+
  - Body sections:
    1. **Report Header**: Case title, case number badge, audit type, status, generated date, assigned to
    2. **Dashboard Stats Cards**: Grid of stat cards (total events, total files, date range, events by type)
    3. **Timeline Chart Placeholder**: `<div id="timeline-chart">{{ timeline_chart_html | safe }}</div>`
    4. **Stats Chart Placeholder**: `<div id="stats-chart">{{ stats_chart_html | safe }}</div>`
    5. **Events Timeline Table**: Iterate over events with date, time, type, file_name, file_count, file_description, file_type
       - For each event, show file_batches as nested rows
    6. **Case Metadata Section**: Display case metadata key-value pairs from audit type schema
    7. **Report Footer**: "Generated by AuditTrail" with timestamp

  Use Jinja2 auto-escaping for all user data. Only use `| safe` for chart HTML divs (pre-generated by Plotly).

  CSS color palette:
  - Header bg: #1e293b (slate-800)
  - Body bg: #f8fafc (slate-50)
  - Card bg: #ffffff
  - Primary text: #0f172a (slate-900)
  - Secondary text: #64748b (slate-500)
  - Border: #e2e8f0 (slate-200)
  - Accent: #3b82f6 (blue-500)
  - Finding badge: #ef4444 (red)
  - Action badge: #22c55e (green)
  - Note badge: #6366f1 (indigo)
  </action>
  <verify>Template file exists and contains no external URL references (no http://, https://, or // protocol references)</verify>
  <done>Complete Jinja2 HTML template with all CSS inlined, professional audit report layout, chart placeholders, events table, and metadata section</done>
</task>

<task type="auto">
  <name>Task 3: HTML report generation service with data collection</name>
  <files>server/src/services/html_report.py</files>
  <action>
  Create server/src/services/html_report.py with:

  1. `HtmlReportService` class with:
     - `__init__`: Set up Jinja2 Environment with FileSystemLoader pointing to server/src/templates/reports/
     - `async def collect_report_data(self, case_id: uuid.UUID, db: AsyncSession) -> dict`:
       - Fetch case with relationships (audit_type, assigned_to, created_by)
       - Fetch all events for case with file_batches, ordered by event_date, event_time
       - Compute dashboard stats: total_events, total_file_batches, total_files (sum of file_count from events + file_batches), date_range, events_by_type counts, events_by_date counts
       - Return dict with case, events, stats, generated_at
     - `def render_html(self, data: dict) -> str`:
       - Load html_report.html template
       - Render with data (chart placeholders will be empty strings for now -- Plan 08-02 adds charts)
       - Return rendered HTML string
     - `async def generate(self, case_id: uuid.UUID, db: AsyncSession) -> tuple[str, str]`:
       - Collect data, render HTML
       - Return (html_content, filename) where filename is f"audit-report-{case.case_number}.html"

  2. Module-level singleton: `html_report_service = HtmlReportService()`

  Use proper error handling: raise HTTPException 404 if case not found.
  Use from_attributes for Pydantic model validation on SQLAlchemy objects.
  </action>
  <verify>python -c "from src.services.html_report import html_report_service; print('OK')" from server directory</verify>
  <done>HTML report service importable, has collect_report_data, render_html, and generate methods</done>
</task>

</tasks>

<verification>
1. All new files are importable without errors
2. Template contains no external URL references
3. Template has all required sections (header, stats, charts, timeline, metadata, footer)
4. Service correctly references the template path
</verification>

<success_criteria>
- Report schemas define DashboardStats, ReportRequest, ReportResponse
- Jinja2 template is a complete, self-contained HTML document with inlined CSS
- Report service collects case + events + stats data from database
- Template renders with placeholder chart sections (empty strings)
- No external URLs in the generated HTML
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-html/08-01-SUMMARY.md`
</output>
