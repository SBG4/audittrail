---
phase: 08-reports-html
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - server/src/services/html_report.py
  - server/tests/test_html_report.py
autonomous: true

must_haves:
  truths:
    - "Generated HTML contains no external URL references (http://, https://, //)"
    - "HTML report works when opened from filesystem (file:// protocol)"
    - "Self-containment verification runs automatically after generation"
  artifacts:
    - path: "server/src/services/html_report.py"
      provides: "Self-containment verification method"
    - path: "server/tests/test_html_report.py"
      provides: "Tests for report generation and self-containment"
  key_links:
    - from: "server/src/services/html_report.py"
      to: "server/src/services/html_report.py"
      via: "verify_self_contained called in generate()"
---

<objective>
Add self-containment verification to the HTML report pipeline and create tests proving the report works offline.

Purpose: REPT-06 requires the HTML report to work when opened directly from the filesystem with no server or network. Verification must be automated to prevent regressions.
Output: Self-containment verification method, automated tests, generation pipeline that validates before returning.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-reports-html/08-RESEARCH.md
@.planning/phases/08-reports-html/08-02-SUMMARY.md
@server/src/services/html_report.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Self-containment verification pipeline</name>
  <files>server/src/services/html_report.py</files>
  <action>
  Add to HtmlReportService:

  1. `def verify_self_contained(self, html: str) -> list[str]`:
     - Scan the HTML string for any external URL references
     - Check patterns:
       a. `https?://` anywhere in the content (except inside Plotly.js source code itself -- Plotly internals may reference URLs in comments/strings, so only check outside of script tags that are plotly.js)
       b. `<link rel="stylesheet"` tags (should be none)
       c. `<script src=` tags pointing to external URLs (should be none)
       d. `@import url(` in style tags
       e. `<img src=` pointing to external URLs (not data: URIs)
     - Strategy: Parse with a pragmatic regex approach:
       - Extract all `href="..."` and `src="..."` attributes
       - Filter out: `href="#..."` (anchor links), `src="data:..."` (data URIs), Plotly internal references within plotly.js script blocks
       - Flag any remaining external references
     - Return list of violation descriptions (empty list = self-contained)

  2. Update `generate()` method:
     - After render_html, call verify_self_contained
     - If violations found, log warnings but still return the HTML (don't block generation)
     - Include verification result in logs

  3. `def get_report_size_info(self, html: str) -> dict`:
     - Return dict with: total_bytes, total_kb, total_mb, has_plotly_js (bool), estimated_chart_count
  </action>
  <verify>python -c "from src.services.html_report import html_report_service; v = html_report_service.verify_self_contained('<html><link rel=\"stylesheet\" href=\"https://cdn.example.com/style.css\"></html>'); print('Violations:', v)" from server directory</verify>
  <done>Self-containment verification detects external URLs, link tags, script src, and @import statements</done>
</task>

<task type="auto">
  <name>Task 2: Report generation tests</name>
  <files>server/tests/test_html_report.py</files>
  <action>
  Create server/tests/test_html_report.py with unit tests:

  1. Test self-containment verification:
     - test_verify_clean_html: Pass HTML with no external refs -> empty violations
     - test_verify_external_stylesheet: Pass HTML with <link rel="stylesheet" href="https://..."> -> violation found
     - test_verify_external_script: Pass HTML with <script src="https://..."> -> violation found
     - test_verify_css_import: Pass HTML with @import url("https://...") -> violation found
     - test_verify_data_uri_ok: Pass HTML with src="data:image/png;base64,..." -> no violation (data URIs are fine)
     - test_verify_anchor_link_ok: Pass HTML with href="#section1" -> no violation (anchor links are fine)

  2. Test chart generation (unit tests with mock data):
     - test_timeline_chart_returns_html: Call _generate_timeline_chart with mock events -> returns string containing "timeline-chart" div
     - test_timeline_chart_includes_plotlyjs: Verify first chart output contains "plotly" script
     - test_stats_chart_excludes_plotlyjs: Verify stats chart does NOT include plotly.js script tag (include_plotlyjs=False)
     - test_empty_events_chart: Call with empty events list -> returns HTML without errors

  3. Test template rendering:
     - test_render_html_basic: Call render_html with minimal mock data -> returns HTML string containing case title
     - test_render_html_escapes_user_data: Pass case title with "<script>alert(1)</script>" -> verify it's escaped in output
     - test_render_html_safe_charts: Pass chart HTML with div tags -> verify chart divs appear in output unescaped

  Use pytest. Create mock data fixtures for case, events, and stats. Don't require database connection for these unit tests.
  </action>
  <verify>cd /Users/shiro/projec1/server && python -m pytest tests/test_html_report.py -v 2>&1 | tail -30</verify>
  <done>All tests pass: self-containment verification, chart generation, template rendering, XSS prevention</done>
</task>

</tasks>

<verification>
1. Self-containment verification catches all external URL patterns
2. Data URIs and anchor links are NOT flagged as violations
3. All tests pass without database connection
4. Template properly escapes user data while allowing safe chart HTML
</verification>

<success_criteria>
- verify_self_contained returns violations for external URLs, stylesheets, scripts, CSS imports
- verify_self_contained does NOT flag data URIs or anchor links
- Chart generation tests confirm plotly.js is included only once
- Template rendering tests confirm XSS prevention via auto-escaping
- All tests pass with `pytest tests/test_html_report.py`
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-html/08-03-SUMMARY.md`
</output>
