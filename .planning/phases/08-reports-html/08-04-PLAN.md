---
phase: 08-reports-html
plan: 04
type: execute
wave: 4
depends_on: ["08-03"]
files_modified:
  - client/src/pages/CaseDetailPage.tsx
  - client/src/hooks/useReports.ts
  - client/src/components/reports/ReportDownloadButton.tsx
autonomous: true

must_haves:
  truths:
    - "User can download HTML report from case detail page"
    - "Download button shows loading state during generation"
    - "Downloaded file opens in browser with interactive charts"
  artifacts:
    - path: "client/src/hooks/useReports.ts"
      provides: "Report download hook"
    - path: "client/src/components/reports/ReportDownloadButton.tsx"
      provides: "Report download button component"
    - path: "client/src/pages/CaseDetailPage.tsx"
      provides: "Updated case detail page with report tab/button"
  key_links:
    - from: "client/src/hooks/useReports.ts"
      to: "/api/cases/{id}/reports/html"
      via: "fetch with blob download"
    - from: "client/src/pages/CaseDetailPage.tsx"
      to: "client/src/components/reports/ReportDownloadButton.tsx"
      via: "component import and render"
---

<objective>
Add the HTML report download UI to the case detail page, including a download button with loading state and the report generation hook.

Purpose: Completes the user-facing workflow for REPT-04/REPT-06 -- auditors can generate and download the self-contained HTML report.
Output: Report download button on case detail page, useReports hook, download triggers browser save dialog.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/08-reports-html/08-RESEARCH.md
@.planning/phases/08-reports-html/08-03-SUMMARY.md
@client/src/pages/CaseDetailPage.tsx
@client/src/lib/api.ts
@client/src/hooks/useCases.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Report download hook and button component</name>
  <files>client/src/hooks/useReports.ts, client/src/components/reports/ReportDownloadButton.tsx</files>
  <action>
  1. Create client/src/hooks/useReports.ts:
     - `useDownloadHtmlReport(caseId: string)` custom hook:
       - Uses useState for loading and error state
       - `downloadHtmlReport` async function:
         - Set loading true
         - Fetch GET `/api/cases/${caseId}/reports/html` with auth token from localStorage
         - Handle response as blob
         - Extract filename from Content-Disposition header, fallback to "audit-report.html"
         - Create temporary anchor element, set href to URL.createObjectURL(blob), set download attribute, click, revoke URL
         - Set loading false
         - On error: set error message, set loading false
       - Return { downloadHtmlReport, isLoading, error }

  2. Create client/src/components/reports/ReportDownloadButton.tsx:
     - Props: `caseId: string`
     - Uses useDownloadHtmlReport hook
     - Renders Button with FileDown icon from lucide-react
     - Text: "Download HTML Report" (or "Generating..." when loading)
     - Disabled when loading
     - Shows error toast/message if generation fails
     - Styled with variant="outline" and appropriate sizing
  </action>
  <verify>Files exist at expected paths and contain the expected exports</verify>
  <done>Report download hook handles fetch-as-blob with auth, button component shows loading state</done>
</task>

<task type="auto">
  <name>Task 2: Integrate report download into case detail page</name>
  <files>client/src/pages/CaseDetailPage.tsx</files>
  <action>
  Update CaseDetailPage.tsx:

  1. Import ReportDownloadButton from "@/components/reports/ReportDownloadButton"

  2. Add a "Reports" tab to the existing Tabs component:
     - TabsTrigger value="reports" with text "Reports"
     - TabsContent for "reports" containing:
       - Section header: "Generate Reports"
       - Description: "Download a self-contained HTML report with interactive charts. The report works offline -- just open the .html file in any browser."
       - ReportDownloadButton with caseId={id!}
       - Info text: "The HTML report includes dashboard statistics, an interactive event timeline, and detailed event data. All charts support hover, zoom, and pan."

  3. Keep existing tabs (Overview, Timeline) unchanged.
  </action>
  <verify>File contains ReportDownloadButton import and Reports tab</verify>
  <done>Case detail page has Reports tab with HTML report download button</done>
</task>

</tasks>

<verification>
1. Report download button appears on case detail page Reports tab
2. Clicking download triggers API call with auth token
3. Browser save dialog appears with correct filename
4. Loading state shown during report generation
5. Error handling works if generation fails
</verification>

<success_criteria>
- Reports tab visible on case detail page
- Download button calls GET /cases/{id}/reports/html
- Response is saved as .html file via browser download
- Loading indicator shown during generation
- Downloaded HTML file contains interactive Plotly charts when opened in browser
</success_criteria>

<output>
After completion, create `.planning/phases/08-reports-html/08-04-SUMMARY.md`
</output>
