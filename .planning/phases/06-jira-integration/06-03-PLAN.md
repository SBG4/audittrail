---
phase: 06-jira-integration
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - client/src/types/jira.ts
  - client/src/hooks/useJira.ts
  - client/src/components/jira/FieldMappingEditor.tsx
  - client/src/pages/FieldMappingsPage.tsx
  - client/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can view current Jira-to-case field mappings for each audit type"
    - "User can add, edit, and remove individual field mapping rows"
    - "User can save mapping changes which updates the database via PUT"
  artifacts:
    - path: "client/src/types/jira.ts"
      provides: "TypeScript interfaces for Jira scrape and mapping types"
    - path: "client/src/hooks/useJira.ts"
      provides: "TanStack Query hooks for Jira API endpoints"
    - path: "client/src/components/jira/FieldMappingEditor.tsx"
      provides: "Editable table of field mappings per audit type"
    - path: "client/src/pages/FieldMappingsPage.tsx"
      provides: "Page with audit type selector and mapping editor"
  key_links:
    - from: "client/src/hooks/useJira.ts"
      to: "/api/jira/mappings"
      via: "api.get and api.put"
      pattern: "api\\.(get|put).*jira/mappings"
    - from: "client/src/App.tsx"
      to: "client/src/pages/FieldMappingsPage.tsx"
      via: "Route element"
      pattern: "FieldMappingsPage"
---

<objective>
Create the field mapping configuration UI that allows users to manage which Jira fields map to which case metadata keys for each audit type.

Purpose: Implements JIRA-03 -- user can configure field mapping per audit type.
Output: FieldMappingsPage with audit type selector and editable mapping table.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@client/src/lib/api.ts
@client/src/hooks/useAuditTypes.ts
@client/src/types/case.ts
@client/src/App.tsx
@.planning/phases/06-jira-integration/06-01-SUMMARY.md
@.planning/phases/06-jira-integration/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types and TanStack Query hooks for Jira</name>
  <files>
    client/src/types/jira.ts
    client/src/hooks/useJira.ts
  </files>
  <action>
  1. Create `client/src/types/jira.ts`:
     ```typescript
     export interface JiraScrapeRequest {
       url: string;
       timeout_ms?: number;
     }

     export interface JiraScrapeResponse {
       url: string;
       fields: Record<string, string>;
       raw_fields: Record<string, string>;
       error: string | null;
       success: boolean;
     }

     export interface JiraFieldMapping {
       id: string;
       audit_type_id: string;
       jira_field_name: string;
       case_metadata_key: string;
     }

     export interface JiraFieldMappingCreate {
       jira_field_name: string;
       case_metadata_key: string;
     }
     ```

  2. Create `client/src/hooks/useJira.ts`:
     - `useJiraFieldMappings(auditTypeId: string)`: useQuery, GET `/api/jira/mappings/${auditTypeId}`, returns `JiraFieldMapping[]`, enabled when auditTypeId is truthy, staleTime 5min
     - `useUpdateJiraFieldMappings()`: useMutation, PUT `/api/jira/mappings/${auditTypeId}`, invalidates ["jira-mappings"] on success
     - `useJiraScrape()`: useMutation, POST `/api/jira/scrape`, returns `JiraScrapeResponse`
     - `useJiraScrapeAndMap()`: useMutation, POST `/api/jira/scrape-and-map?audit_type_id=${auditTypeId}`, returns `JiraScrapeResponse`
  </action>
  <verify>
  - `grep -r "useJiraFieldMappings\|useJiraScrape" client/src/hooks/useJira.ts` finds all 4 hooks
  - TypeScript types file exists with all interfaces
  </verify>
  <done>TypeScript types for Jira API and 4 TanStack Query hooks for scraping and mapping management.</done>
</task>

<task type="auto">
  <name>Task 2: Field mapping editor component and settings page</name>
  <files>
    client/src/components/jira/FieldMappingEditor.tsx
    client/src/pages/FieldMappingsPage.tsx
    client/src/App.tsx
  </files>
  <action>
  1. Create `client/src/components/jira/FieldMappingEditor.tsx`:
     Props: `auditTypeId: string`, `schema: JsonSchema` (from case.ts -- to show available metadata keys)

     Component behavior:
     - Uses `useJiraFieldMappings(auditTypeId)` to load current mappings
     - Maintains local state `localMappings: JiraFieldMappingCreate[]` initialized from fetched data
     - Renders a table with columns: Jira Field Name (text input), Case Metadata Key (Select from schema.properties keys), Remove button
     - "Add Mapping" button appends empty row
     - Remove button removes row from local state
     - "Save Mappings" button calls `useUpdateJiraFieldMappings()` with `{ auditTypeId, mappings: localMappings }`
     - Shows success/error feedback
     - Case metadata key select options derived from `schema.properties` keys with their titles as labels

     Use existing UI components: Button, Input, Select, Table, Card.

  2. Create `client/src/pages/FieldMappingsPage.tsx`:
     - Title: "Jira Field Mappings"
     - Subtitle: "Configure how Jira issue fields map to case metadata for each audit type"
     - Uses `useAuditTypes()` to list audit types
     - Select dropdown to pick audit type
     - When audit type selected, shows `FieldMappingEditor` with the selected audit type's id and schema
     - Back link to "/"

  3. Update `client/src/App.tsx`:
     - Import `FieldMappingsPage` from `@/pages/FieldMappingsPage`
     - Add route: `<Route path="/settings/jira-mappings" element={<FieldMappingsPage />} />`
     - Place inside the authenticated Layout routes
  </action>
  <verify>
  - `grep "FieldMappingsPage" client/src/App.tsx` finds import and route
  - `grep "FieldMappingEditor" client/src/components/jira/FieldMappingEditor.tsx` finds component
  - `grep "jira-mappings" client/src/App.tsx` finds the route path
  </verify>
  <done>FieldMappingEditor component renders editable mapping table with add/remove/save. FieldMappingsPage provides audit type selection and mapping editor. Route registered at /settings/jira-mappings.</done>
</task>

</tasks>

<verification>
- All TypeScript types compile without errors
- Hooks reference correct API endpoints
- FieldMappingEditor receives schema props and renders mapping rows
- FieldMappingsPage loads audit types and passes to editor
- Route accessible at /settings/jira-mappings within authenticated layout
</verification>

<success_criteria>
- User can navigate to /settings/jira-mappings
- User can select an audit type and see existing mappings
- User can add/remove/edit mapping rows
- User can save changes (PUT to server)
</success_criteria>

<output>
After completion, create `.planning/phases/06-jira-integration/06-03-SUMMARY.md`
</output>
