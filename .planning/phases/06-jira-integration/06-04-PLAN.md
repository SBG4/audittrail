---
phase: 06-jira-integration
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - client/src/components/jira/JiraImportPanel.tsx
  - client/src/pages/CaseCreatePage.tsx
  - client/src/pages/CaseDetailPage.tsx
  - client/src/components/cases/CaseMetadata.tsx
autonomous: true

must_haves:
  truths:
    - "User can paste a Jira URL in the case creation form and click Import"
    - "Scraped and mapped data is shown for review before applying"
    - "User can accept or dismiss scraped values which pre-fill metadata fields"
    - "Jira import is available on both create and detail pages"
  artifacts:
    - path: "client/src/components/jira/JiraImportPanel.tsx"
      provides: "Jira URL input, scrape trigger, scraped data review, apply button"
  key_links:
    - from: "client/src/components/jira/JiraImportPanel.tsx"
      to: "client/src/hooks/useJira.ts"
      via: "useJiraScrapeAndMap mutation"
      pattern: "useJiraScrapeAndMap"
    - from: "client/src/pages/CaseCreatePage.tsx"
      to: "client/src/components/jira/JiraImportPanel.tsx"
      via: "JSX component inclusion"
      pattern: "JiraImportPanel"
    - from: "client/src/pages/CaseDetailPage.tsx"
      to: "client/src/components/jira/JiraImportPanel.tsx"
      via: "JSX component inclusion via CaseMetadata"
      pattern: "JiraImportPanel"
---

<objective>
Create the Jira import panel that allows users to paste a Jira URL, preview scraped data, and apply it to case metadata fields -- integrated into both case creation and case detail pages.

Purpose: Implements JIRA-01 and JIRA-04 -- user provides Jira URL, sees scraped values for review, and applies them to the case form.
Output: JiraImportPanel component integrated into CaseCreatePage and CaseDetailPage.
</objective>

<execution_context>
@/Users/shiro/.claude/get-shit-done/workflows/execute-plan.md
@/Users/shiro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@client/src/pages/CaseCreatePage.tsx
@client/src/pages/CaseDetailPage.tsx
@client/src/components/cases/CaseMetadata.tsx
@client/src/components/cases/SchemaForm.tsx
@client/src/hooks/useJira.ts
@client/src/types/jira.ts
@client/src/types/case.ts
@.planning/phases/06-jira-integration/06-01-SUMMARY.md
@.planning/phases/06-jira-integration/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: JiraImportPanel component</name>
  <files>
    client/src/components/jira/JiraImportPanel.tsx
  </files>
  <action>
  Create `client/src/components/jira/JiraImportPanel.tsx`:

  Props:
  - `auditTypeId: string` -- the current case's audit type ID
  - `onApply: (metadata: Record<string, string>) => void` -- callback when user applies scraped data
  - `currentMetadata?: Record<string, unknown>` -- current metadata values (to show what will change)
  - `schema?: JsonSchema` -- audit type schema (to show metadata key labels)

  Component state:
  - `jiraUrl: string` -- input field value
  - `showPreview: boolean` -- whether to show the review panel

  Uses `useJiraScrapeAndMap()` mutation hook.

  UI structure:
  1. **URL input section** (Card):
     - Label: "Import from Jira"
     - Input field for Jira URL with placeholder "https://jira.internal/browse/PROJ-123"
     - "Fetch" button that triggers the scrape-and-map mutation
     - Loading state: button shows "Fetching..." and is disabled during mutation
     - Error state: show error message below input in red text

  2. **Preview/Review section** (shown after successful scrape):
     - Card with title "Scraped Data Review"
     - Table with columns: Field, Scraped Value, Action
     - For each entry in `response.fields`:
       - Show the case metadata key label (from schema.properties[key].title or key)
       - Show the scraped value
       - If currentMetadata has a different existing value, show it struck through above the new value
     - Also show a section "Unmapped Fields" listing raw_fields entries that are NOT in the mapped fields
       - These are informational only, showing what Jira fields were found but not mapped
     - "Apply All" button: calls `onApply` with the mapped fields dict
     - "Dismiss" button: hides the preview panel

  Styling:
  - Use existing Card, Button, Input, Table, Badge components
  - Compact layout suitable for embedding in a form
  - Badge "New" for values that will be added, Badge "Changed" for values that differ from current
  </action>
  <verify>
  - File exists at client/src/components/jira/JiraImportPanel.tsx
  - `grep "useJiraScrapeAndMap" client/src/components/jira/JiraImportPanel.tsx` finds the hook usage
  - `grep "onApply" client/src/components/jira/JiraImportPanel.tsx` finds the callback prop
  </verify>
  <done>JiraImportPanel renders URL input, triggers scrape-and-map, shows review table with mapped and unmapped fields, and Apply/Dismiss actions.</done>
</task>

<task type="auto">
  <name>Task 2: Integrate JiraImportPanel into case pages</name>
  <files>
    client/src/pages/CaseCreatePage.tsx
    client/src/pages/CaseDetailPage.tsx
    client/src/components/cases/CaseMetadata.tsx
  </files>
  <action>
  1. Update `client/src/pages/CaseCreatePage.tsx`:
     - Import JiraImportPanel from `@/components/jira/JiraImportPanel`
     - After the "Metadata Fields" Card and before the error display, add a new Card:
       - Only show when `auditTypeId` is selected (truthy)
       - Contains `JiraImportPanel` with:
         - `auditTypeId={auditTypeId}`
         - `onApply={(scraped) => setMetadata(prev => ({ ...prev, ...scraped }))}`
         - `currentMetadata={metadata}`
         - `schema={selectedAuditType?.schema}`
     - The onApply callback merges scraped values into existing metadata state, so SchemaForm above updates reactively

  2. Update `client/src/components/cases/CaseMetadata.tsx`:
     - Import JiraImportPanel from `@/components/jira/JiraImportPanel`
     - In VIEW mode (not editing), add JiraImportPanel below the metadata grid:
       - `auditTypeId={case_.audit_type_id}`
       - `onApply={(scraped) => onSave({ ...case_.metadata, ...scraped })}`
       - `currentMetadata={case_.metadata}`
       - `schema={schema}`
     - This allows importing Jira data into an existing case from the detail page
     - The onApply callback merges scraped data with existing metadata and saves via the existing onSave prop

  3. No changes needed to CaseDetailPage.tsx itself since CaseMetadata handles the integration.
  </action>
  <verify>
  - `grep "JiraImportPanel" client/src/pages/CaseCreatePage.tsx` finds the component
  - `grep "JiraImportPanel" client/src/components/cases/CaseMetadata.tsx` finds the component
  - `grep "onApply" client/src/pages/CaseCreatePage.tsx` finds the merge callback
  </verify>
  <done>JiraImportPanel integrated into CaseCreatePage (below metadata fields when audit type selected) and CaseMetadata component (in view mode on detail page). Scraped data merges into metadata state for review before form submission.</done>
</task>

</tasks>

<verification>
- JiraImportPanel component renders URL input and fetch button
- CaseCreatePage shows JiraImportPanel when audit type is selected
- CaseDetailPage shows JiraImportPanel in the metadata section
- Scraped data flows into metadata form fields for user review
- Apply action merges scraped values without losing existing metadata
</verification>

<success_criteria>
- User can paste Jira URL on case create page and import data into metadata fields
- User can paste Jira URL on case detail page and import data into existing metadata
- Scraped values shown for review before applying
- Unmapped fields shown for informational purposes
- Error states handled gracefully (timeout, network error, parse failure)
</success_criteria>

<output>
After completion, create `.planning/phases/06-jira-integration/06-04-SUMMARY.md`
</output>
